
    <div class="preferences-container">
      <!-- Header -->
      <div class="preferences-header">
        <div class="header-nav">
          <a [routerLink]="'/' + role + '/notifications'" class="back-link">
            ‚Üê Back to Notifications
          </a>
        </div>
        <h1>Notification Preferences</h1>
        <p>Control how and when you receive notifications about your activities.</p>
      </div>

      <!-- Loading State -->
      <div *ngIf="loadingService.isLoading(loadingKey)" class="loading-container">
        <div class="loading-spinner"></div>
        <p>Loading preferences...</p>
      </div>

      <!-- Error State -->
      <div *ngIf="error" class="error-container">
        <div class="error-icon">‚ö†Ô∏è</div>
        <h3>Unable to load preferences</h3>
        <p>{{ error }}</p>
        <button class="btn btn-primary" (click)="loadPreferences()">Try Again</button>
      </div>

      <!-- Preferences Form -->
      <form *ngIf="!loadingService.isLoading(loadingKey) && !error && preferencesForm" [formGroup]="preferencesForm" (ngSubmit)="savePreferences()">

        <!-- Email Notifications Section -->
        <div class="preferences-section">
          <h2>Email Notifications</h2>
          <p class="section-description">Choose which notifications you'd like to receive via email.</p>

          <div class="preference-group">
            <!-- Master Email Toggle -->
            <div class="preference-item master-toggle">
              <div class="preference-content">
                <label for="emailEnabled" class="preference-label">
                  <strong>Enable Email Notifications</strong>
                </label>
                <p class="preference-description">
                  Turn email notifications on or off completely. When disabled, you'll only receive in-app notifications.
                </p>
              </div>
              <div class="preference-control">
                <label class="toggle-switch">
                  <input
                    type="checkbox"
                    id="emailEnabled"
                    formControlName="emailEnabled"
                    (change)="onMasterEmailToggle()">
                  <span class="toggle-slider"></span>
                </label>
              </div>
            </div>

            <!-- Individual Email Preferences -->
            <div class="email-preferences" [class.disabled]="!preferencesForm.get('emailEnabled')?.value">

              <!-- Common notifications for all roles -->
              <div class="preference-item">
                <div class="preference-content">
                  <label for="emailWelcome" class="preference-label">Welcome Messages üéâ</label>
                  <p class="preference-description">Get notified about account approvals and important welcome information</p>
                </div>
                <div class="preference-control">
                  <label class="toggle-switch">
                    <input
                      type="checkbox"
                      id="emailWelcome"
                      formControlName="emailAccountUpdate"
                      [disabled]="!preferencesForm.get('emailEnabled')?.value">
                    <span class="toggle-slider"></span>
                  </label>
                </div>
              </div>

              <!-- consignor-specific preferences -->
              <div *ngIf="role === 'consignor'" class="role-specific-preferences">
                <div class="preference-item">
                  <div class="preference-content">
                    <label for="emailItemSold" class="preference-label">Item Sold üí∞</label>
                    <p class="preference-description">Get notified when one of your items sells</p>
                  </div>
                  <div class="preference-control">
                    <label class="toggle-switch">
                      <input
                        type="checkbox"
                        id="emailItemSold"
                        formControlName="emailItemSold"
                        [disabled]="!preferencesForm.get('emailEnabled')?.value">
                      <span class="toggle-slider"></span>
                    </label>
                  </div>
                </div>

                <div class="preference-item">
                  <div class="preference-content">
                    <label for="emailPayoutProcessed" class="preference-label">Payout Processed üí≥</label>
                    <p class="preference-description">Get notified when a payout has been processed</p>
                  </div>
                  <div class="preference-control">
                    <label class="toggle-switch">
                      <input
                        type="checkbox"
                        id="emailPayoutProcessed"
                        formControlName="emailPayoutProcessed"
                        [disabled]="!preferencesForm.get('emailEnabled')?.value">
                      <span class="toggle-slider"></span>
                    </label>
                  </div>
                </div>

                <div class="preference-item">
                  <div class="preference-content">
                    <label for="emailStatementReady" class="preference-label">Monthly Statement üìÑ</label>
                    <p class="preference-description">Get notified when your monthly statement is ready</p>
                  </div>
                  <div class="preference-control">
                    <label class="toggle-switch">
                      <input
                        type="checkbox"
                        id="emailStatementReady"
                        formControlName="emailStatementReady"
                        [disabled]="!preferencesForm.get('emailEnabled')?.value">
                      <span class="toggle-slider"></span>
                    </label>
                  </div>
                </div>
              </div>

              <!-- Owner-specific preferences -->
              <div *ngIf="role === 'owner'" class="role-specific-preferences">
                <div class="preference-item">
                  <div class="preference-content">
                    <label for="emailNewProviderRequest" class="preference-label">New consignor Requests üë§</label>
                    <p class="preference-description">Get notified when consignors want to join your shop</p>
                  </div>
                  <div class="preference-control">
                    <label class="toggle-switch">
                      <input
                        type="checkbox"
                        id="emailNewProviderRequest"
                        formControlName="emailNewProviderRequest"
                        [disabled]="!preferencesForm.get('emailEnabled')?.value">
                      <span class="toggle-slider"></span>
                    </label>
                  </div>
                </div>

                <div class="preference-item">
                  <div class="preference-content">
                    <label for="emailPayoutDueReminder" class="preference-label">Payout Reminders ‚ö†Ô∏è</label>
                    <p class="preference-description">Get notified when consignors have earnings ready for payout</p>
                  </div>
                  <div class="preference-control">
                    <label class="toggle-switch">
                      <input
                        type="checkbox"
                        id="emailPayoutDueReminder"
                        formControlName="emailPayoutDueReminder"
                        [disabled]="!preferencesForm.get('emailEnabled')?.value">
                      <span class="toggle-slider"></span>
                    </label>
                  </div>
                </div>

                <div class="preference-item">
                  <div class="preference-content">
                    <label for="emailSyncError" class="preference-label">Integration Errors ‚ùå</label>
                    <p class="preference-description">Get notified about Square, QuickBooks, or other sync issues</p>
                  </div>
                  <div class="preference-control">
                    <label class="toggle-switch">
                      <input
                        type="checkbox"
                        id="emailSyncError"
                        formControlName="emailSyncError"
                        [disabled]="!preferencesForm.get('emailEnabled')?.value">
                      <span class="toggle-slider"></span>
                    </label>
                  </div>
                </div>

                <div class="preference-item">
                  <div class="preference-content">
                    <label for="emailSubscriptionReminder" class="preference-label">Subscription Updates üí≥</label>
                    <p class="preference-description">Get notified about subscription renewals and billing issues</p>
                  </div>
                  <div class="preference-control">
                    <label class="toggle-switch">
                      <input
                        type="checkbox"
                        id="emailSubscriptionReminder"
                        formControlName="emailSubscriptionReminder"
                        [disabled]="!preferencesForm.get('emailEnabled')?.value">
                      <span class="toggle-slider"></span>
                    </label>
                  </div>
                </div>
              </div>

              <!-- Admin-specific preferences -->
              <div *ngIf="role === 'admin'" class="role-specific-preferences">
                <div class="preference-item">
                  <div class="preference-content">
                    <label for="emailNewOwnerRequest" class="preference-label">New Shop Registrations üè™</label>
                    <p class="preference-description">Get notified when new shops register on the platform</p>
                  </div>
                  <div class="preference-control">
                    <label class="toggle-switch">
                      <input
                        type="checkbox"
                        id="emailNewOwnerRequest"
                        formControlName="emailNewOwnerRequest"
                        [disabled]="!preferencesForm.get('emailEnabled')?.value">
                      <span class="toggle-slider"></span>
                    </label>
                  </div>
                </div>

                <div class="preference-item">
                  <div class="preference-content">
                    <label for="emailSubscriptionEvents" class="preference-label">Subscription Events üí≥</label>
                    <p class="preference-description">Get notified about new subscriptions, cancellations, and payment failures</p>
                  </div>
                  <div class="preference-control">
                    <label class="toggle-switch">
                      <input
                        type="checkbox"
                        id="emailSubscriptionEvents"
                        formControlName="emailSubscriptionEvents"
                        [disabled]="!preferencesForm.get('emailEnabled')?.value">
                      <span class="toggle-slider"></span>
                    </label>
                  </div>
                </div>

                <div class="preference-item">
                  <div class="preference-content">
                    <label for="emailSystemErrors" class="preference-label">System Errors üö®</label>
                    <p class="preference-description">Get notified about critical system errors and platform issues</p>
                  </div>
                  <div class="preference-control">
                    <label class="toggle-switch">
                      <input
                        type="checkbox"
                        id="emailSystemErrors"
                        formControlName="emailSystemErrors"
                        [disabled]="!preferencesForm.get('emailEnabled')?.value">
                      <span class="toggle-slider"></span>
                    </label>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Digest Settings Section -->
        <div class="preferences-section">
          <h2>Digest Settings</h2>
          <p class="section-description">Control how often you receive email notifications.</p>

          <div class="preference-group">
            <div class="form-group">
              <label for="digestMode" class="form-label">Email Frequency</label>
              <select
                id="digestMode"
                formControlName="digestMode"
                class="form-select"
                [disabled]="!preferencesForm.get('emailEnabled')?.value">
                <option value="instant">Instant (as they happen)</option>
                <option value="daily">Daily Digest</option>
                <option value="weekly">Weekly Digest</option>
              </select>
              <div class="form-help">
                Choose how often you want to receive email notifications
              </div>
            </div>

            <div *ngIf="preferencesForm.get('digestMode')?.value === 'daily'" class="form-group">
              <label for="digestTime" class="form-label">Daily Digest Time</label>
              <input
                type="time"
                id="digestTime"
                formControlName="digestTime"
                class="form-input"
                [disabled]="!preferencesForm.get('emailEnabled')?.value">
              <div class="form-help">
                What time of day should we send your daily digest?
              </div>
            </div>

            <div *ngIf="preferencesForm.get('digestMode')?.value === 'weekly'" class="form-group">
              <label for="digestDay" class="form-label">Weekly Digest Day</label>
              <select
                id="digestDay"
                formControlName="digestDay"
                class="form-select"
                [disabled]="!preferencesForm.get('emailEnabled')?.value">
                <option value="1">Monday</option>
                <option value="2">Tuesday</option>
                <option value="3">Wednesday</option>
                <option value="4">Thursday</option>
                <option value="5">Friday</option>
                <option value="6">Saturday</option>
                <option value="0">Sunday</option>
              </select>
              <div class="form-help">
                What day of the week should we send your weekly digest?
              </div>
            </div>
          </div>
        </div>

        <!-- Payout Threshold Section (consignor and Owner only) -->
        <div *ngIf="role === 'consignor'" class="preferences-section">
          <h2>Payout Alerts</h2>
          <p class="section-description">Get notified when your pending earnings reach a certain amount.</p>

          <div class="preference-group">
            <div class="form-group">
              <label for="payoutPendingThreshold" class="form-label">Pending Payout Threshold</label>
              <div class="input-group">
                <span class="input-group-text">$</span>
                <input
                  type="number"
                  id="payoutPendingThreshold"
                  formControlName="payoutPendingThreshold"
                  class="form-input"
                  min="0"
                  step="0.01"
                  [disabled]="!preferencesForm.get('emailEnabled')?.value || !preferencesForm.get('emailPayoutPending')?.value">
              </div>
              <div class="form-help">
                Get notified when your pending earnings reach this amount (minimum $10)
              </div>
              <div *ngIf="preferencesForm.get('payoutPendingThreshold')?.errors?.['min']" class="form-error">
                Minimum threshold is $10.00
              </div>
            </div>
          </div>
        </div>

        <!-- Save Actions -->
        <div class="save-actions">
          <button
            type="button"
            class="btn btn-secondary"
            (click)="resetForm()"
            [disabled]="!preferencesForm.dirty || loadingService.isLoading(saveLoadingKey)">
            Reset Changes
          </button>
          <button
            type="submit"
            class="btn btn-primary"
            [disabled]="!preferencesForm.dirty || preferencesForm.invalid || loadingService.isLoading(saveLoadingKey)">
            <span *ngIf="loadingService.isLoading(saveLoadingKey)">Saving...</span>
            <span *ngIf="!loadingService.isLoading(saveLoadingKey)">Save Preferences</span>
          </button>
        </div>

        <!-- Save Status -->
        <div *ngIf="saveMessage" class="save-status" [class.success]="saveSuccess" [class.error]="!saveSuccess">
          {{ saveMessage }}
        </div>
      </form>
    </div>
  