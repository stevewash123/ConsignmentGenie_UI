<div class="consignor-settings">
  <div class="settings-header">
    <h2>Consignor Settings</h2>
    <p>Manage how new consignors join your shop and configure approval settings</p>
  </div>

  <div class="settings-form" *ngIf="settings()">
    <!-- Store Code -->
    <div class="form-section">
      <h3>Store Code</h3>
      <p class="section-description">
        Share this code with consignors to let them join your shop.
      </p>

      <div class="store-code-display">
        <div class="code-box">
          <span class="store-code">{{ settings()?.storeCode }}</span>
        </div>
        <div class="code-actions">
          <button class="btn-secondary" (click)="copyStoreCode()">Copy Code</button>
          <button class="btn-secondary" (click)="regenerateStoreCode()">Regenerate</button>
        </div>
      </div>

      <div class="signup-link">
        <label>Direct signup link:</label>
        <div class="link-display">
          <span class="signup-url">{{ settings()?.signupUrl }}</span>
          <button class="btn-link" (click)="copySignupLink()">Copy Link</button>
        </div>
      </div>
    </div>

    <!-- Consignor Approval -->
    <div class="form-section">
      <h3>Consignor Approval</h3>

      <div class="approval-options">
        <label class="radio-option" [class.selected]="settings()?.autoApprove">
          <input
            type="radio"
            [value]="true"
            [(ngModel)]="settings()!.autoApprove"
            name="approvalType">
          <div class="option-content">
            <span class="option-title">Auto-approve new consignors</span>
            <span class="option-description">New consignors can immediately start adding items</span>
          </div>
        </label>

        <label class="radio-option" [class.selected]="!settings()?.autoApprove">
          <input
            type="radio"
            [value]="false"
            [(ngModel)]="settings()!.autoApprove"
            name="approvalType">
          <div class="option-content">
            <span class="option-title">Require manual approval</span>
            <span class="option-description">Review each consignor before they can add items</span>
          </div>
        </label>
      </div>
    </div>

    <!-- Default Consignor Terms -->
    <div class="form-section">
      <h3>Default Consignor Terms</h3>
      <p class="section-description">
        These terms apply to all new consignors by default. You can customize them per consignor later.
      </p>

      <div class="form-group">
        <label for="shopCommissionPercent">Shop Commission (%)</label>
        <input
          type="number"
          id="shopCommissionPercent"
          [(ngModel)]="settings()!.defaults.shopCommissionPercent"
          name="shopCommissionPercent"
          class="form-input number-input"
          min="1"
          max="99"
          placeholder="50">
        <div class="field-hint">Consignor receives the remaining percentage ({{ 100 - (settings()?.defaults?.shopCommissionPercent || 0) }}%)</div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="consignmentPeriodDays">Consignment Period (days)</label>
          <input
            type="number"
            id="consignmentPeriodDays"
            [(ngModel)]="settings()!.defaults.consignmentPeriodDays"
            name="consignmentPeriodDays"
            class="form-input number-input"
            min="1"
            placeholder="90">
          <div class="field-hint">How long items stay on sale</div>
        </div>

        <div class="form-group">
          <label for="retrievalPeriodDays">Retrieval Period (days)</label>
          <input
            type="number"
            id="retrievalPeriodDays"
            [(ngModel)]="settings()!.defaults.retrievalPeriodDays"
            name="retrievalPeriodDays"
            class="form-input number-input"
            min="1"
            placeholder="14">
          <div class="field-hint">How long consignors have to pick up unsold items</div>
        </div>
      </div>

      <div class="form-group">
        <label for="unsoldItemPolicy">Unclaimed Item Policy</label>
        <select
          id="unsoldItemPolicy"
          [(ngModel)]="settings()!.defaults.unsoldItemPolicy"
          name="unsoldItemPolicy"
          class="form-select">
          <option value="return-to-consignor">Return to consignor</option>
          <option value="become-shop-property">Become shop property</option>
          <option value="donate">Donate to charity</option>
          <option value="dispose">Dispose of items</option>
        </select>
        <div class="field-hint">What happens to items left unclaimed after the retrieval period</div>
      </div>
    </div>

    <!-- Agreement Settings -->
    <div class="form-section">
      <h3>Consignment Agreements</h3>
      <p class="section-description">
        Configure how consignment agreements are handled with new consignors.
      </p>

      <!-- Template Status Warning -->
      <div class="agreement-status" *ngIf="!settings()?.agreements?.templateCustomized">
        <div class="warning-banner">
          <div class="warning-icon">‚ö†Ô∏è</div>
          <div class="warning-content">
            <strong>Agreement template not customized.</strong>
            <a href="/settings/integrations" class="warning-link">Edit Template</a> before enabling auto-send.
          </div>
        </div>
      </div>

      <div class="form-group">
        <label class="permission-toggle">
          <input
            type="checkbox"
            [(ngModel)]="settings()!.agreements.autoSendOnRegistration"
            name="autoSendOnRegistration"
            [disabled]="!settings()?.agreements?.templateCustomized">
          <div class="toggle-switch"></div>
          <div class="permission-content">
            <span class="permission-title">Auto-send agreement when consignor registers</span>
            <span class="permission-description">Automatically email agreement to new consignors</span>
          </div>
        </label>
      </div>

      <div class="form-group">
        <label class="permission-toggle">
          <input
            type="checkbox"
            [(ngModel)]="settings()!.agreements.requireBeforeItems"
            name="requireBeforeItems">
          <div class="toggle-switch"></div>
          <div class="permission-content">
            <span class="permission-title">Require signed agreement before item submission</span>
            <span class="permission-description">Block item submission until agreement is on file</span>
          </div>
        </label>
      </div>
    </div>

    <!-- Notification Preferences -->
    <div class="form-section">
      <h3>Notification Preferences</h3>
      <p class="section-description">
        Choose which consignor-related activities will send you email notifications.
      </p>

      <div class="permissions-grid">
        <div class="permission-item">
          <label class="permission-toggle">
            <input
              type="checkbox"
              [(ngModel)]="settings()!.notifications.newConsignorRegistration"
              name="newConsignorRegistration">
            <div class="toggle-switch"></div>
            <div class="permission-content">
              <span class="permission-title">Notify me when new consignors register</span>
              <span class="permission-description">Get an email when someone joins your shop</span>
            </div>
          </label>
        </div>

        <div class="permission-item">
          <label class="permission-toggle">
            <input
              type="checkbox"
              [(ngModel)]="settings()!.notifications.itemSubmissions"
              name="itemSubmissions">
            <div class="toggle-switch"></div>
            <div class="permission-content">
              <span class="permission-title">Notify me when consignors submit items</span>
              <span class="permission-description">Get an email when new items are submitted for approval</span>
            </div>
          </label>
        </div>

        <div class="permission-item">
          <label class="permission-toggle">
            <input
              type="checkbox"
              [(ngModel)]="settings()!.notifications.payoutRequests"
              name="payoutRequests">
            <div class="toggle-switch"></div>
            <div class="permission-content">
              <span class="permission-title">Notify me when consignors request payouts</span>
              <span class="permission-description">Get an email when payouts are requested</span>
            </div>
          </label>
        </div>
      </div>
    </div>

    <!-- Inventory Permissions -->
    <div class="form-section">
      <h3>Consignor Inventory Permissions</h3>
      <p class="section-description">
        Control what actions consignors can perform with their inventory items.
      </p>

      <div class="permissions-grid">
        <div class="permission-item">
          <label class="permission-toggle">
            <input
              type="checkbox"
              [(ngModel)]="settings()!.inventoryPermissions.canAddItems"
              name="canAddItems">
            <div class="toggle-switch"></div>
            <div class="permission-content">
              <span class="permission-title">Add new items</span>
              <span class="permission-description">Allow consignors to submit new items for approval</span>
            </div>
          </label>
        </div>

        <div class="permission-item">
          <label class="permission-toggle">
            <input
              type="checkbox"
              [(ngModel)]="settings()!.inventoryPermissions.canEditItems"
              name="canEditItems">
            <div class="toggle-switch"></div>
            <div class="permission-content">
              <span class="permission-title">Edit existing items</span>
              <span class="permission-description">Allow consignors to modify details of their approved items</span>
            </div>
          </label>
        </div>

        <div class="permission-item">
          <label class="permission-toggle">
            <input
              type="checkbox"
              [(ngModel)]="settings()!.inventoryPermissions.canRemoveItems"
              name="canRemoveItems">
            <div class="toggle-switch"></div>
            <div class="permission-content">
              <span class="permission-title">Remove/withdraw items</span>
              <span class="permission-description">Allow consignors to withdraw items from the shop</span>
            </div>
          </label>
        </div>

        <div class="permission-item">
          <label class="permission-toggle">
            <input
              type="checkbox"
              [(ngModel)]="settings()!.inventoryPermissions.canViewDetailedAnalytics"
              name="canViewDetailedAnalytics">
            <div class="toggle-switch"></div>
            <div class="permission-content">
              <span class="permission-title">View detailed analytics</span>
              <span class="permission-description">Allow consignors to see detailed sales metrics and performance data</span>
            </div>
          </label>
        </div>
      </div>

      <div class="permissions-note">
        <div class="note-icon">üí°</div>
        <div class="note-content">
          <strong>Note:</strong> Consignors can always view their basic inventory list and sale notifications.
          These permissions control additional actions and data access.
        </div>
      </div>
    </div>

    <!-- Invite Consignors -->
    <div class="form-section">
      <h3>Invite Consignors</h3>

      <div class="invite-form">
        <div class="form-group">
          <label for="inviteEmails">Email addresses (one per line)</label>
          <textarea
            id="inviteEmails"
            [(ngModel)]="inviteEmailsText"
            name="inviteEmails"
            class="form-textarea invite-emails"
            placeholder="jane@example.com&#10;bob@example.com"
            rows="4"></textarea>
        </div>

        <div class="form-group">
          <label for="inviteMessage">Custom message (optional)</label>
          <textarea
            id="inviteMessage"
            [(ngModel)]="customMessage"
            name="inviteMessage"
            class="form-textarea"
            placeholder="Join our consignment family! We'd love to have your items in our shop..."
            rows="3"></textarea>
        </div>

        <div class="invite-actions">
          <button
            class="btn-primary"
            (click)="sendInvitations()"
            [disabled]="isSending() || !inviteEmailsText.trim()">
            {{ isSending() ? 'Sending...' : 'Send Invitations' }}
          </button>
        </div>
      </div>
    </div>

    <!-- Pending Invitations -->
    <div class="form-section" *ngIf="pendingInvitations().length > 0">
      <h3>Pending Invitations</h3>

      <div class="invitations-list">
        <div
          *ngFor="let invitation of pendingInvitations()"
          class="invitation-item"
          [class]="'status-' + invitation.status">
          <div class="invitation-info">
            <div class="invitation-email">{{ invitation.email }}</div>
            <div class="invitation-details">
              <span>Sent {{ invitation.sentAt | date:'MMM d' }}</span>
              <span class="separator">‚Ä¢</span>
              <span class="status" [class]="'status-' + invitation.status">
                {{ getInvitationStatusText(invitation) }}
              </span>
            </div>
          </div>
          <div class="invitation-actions">
            <button
              *ngIf="invitation.status === 'pending'"
              class="btn-secondary btn-small"
              (click)="resendInvitation(invitation.id)">
              Resend
            </button>
            <button
              class="btn-danger-outline btn-small"
              (click)="cancelInvitation(invitation.id)">
              {{ invitation.status === 'pending' ? 'Cancel' : 'Remove' }}
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Actions -->
    <div class="form-actions">
      <button type="button" class="btn-secondary" (click)="loadSettings()">Cancel</button>
      <button type="button" class="btn-primary" (click)="saveSettings()" [disabled]="isSaving()">
        {{ isSaving() ? 'Saving...' : 'Save Changes' }}
      </button>
    </div>
  </div>

  <!-- Messages -->
  <div class="messages" *ngIf="successMessage() || errorMessage()">
    <div *ngIf="successMessage()" class="message success">{{ successMessage() }}</div>
    <div *ngIf="errorMessage()" class="message error">{{ errorMessage() }}</div>
  </div>
</div>