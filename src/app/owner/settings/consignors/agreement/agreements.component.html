<div class="agreement-template-editor">
  <div class="page-header">
    <h2>Consignment Agreement</h2>
    <p>Customize your consignment agreement with placeholders that will be automatically filled when generating agreements for consignors.</p>

    <!-- Warning when template editing is disabled -->
    <div class="warning-panel" *ngIf="!isTemplateEditingEnabled()">
      <div class="warning-icon">‚ö†Ô∏è</div>
      <div class="warning-content">
        Template editing is disabled because the agreement requirement is set to "No action required" in Consignor Onboarding settings.
        <a routerLink="/owner/settings/consignors/onboarding">Change onboarding settings</a> to enable template editing.
      </div>
    </div>

  </div>

  <!-- Agreement Settings -->
  <div class="form-section">
    <h3>Consignment Agreements</h3>
    <p class="section-description">
      Configure how consignment agreements are handled with new consignors.
    </p>

    <div class="form-group">
      <label class="permission-toggle">
        <input
          type="checkbox"
          [checked]="settings()?.requireSignedAgreement || false"
          (change)="onRequireSignedChange($any($event.target).checked)"
          name="requireBeforeItems">
        <div class="toggle-switch"></div>
        <div class="permission-content">
          <span class="permission-title">Require signed agreement before activating account</span>
          <span class="permission-description">Block account activation until agreement is on file</span>
        </div>
      </label>
    </div>

    <!-- Error when require agreement is checked but no agreement uploaded -->
    <div class="error-panel" *ngIf="showAgreementRequiredError()">
      <div class="error-icon">‚ùå</div>
      <div class="error-content">
        <strong>Agreement Required</strong><br>
        You have enabled "Require signed agreement" but no agreement template has been uploaded.

        <div class="error-actions">
          <label for="error-upload-input" class="btn-primary btn-small">
            <span>üì§</span>
            Upload Agreement Template
          </label>
          <input
            id="error-upload-input"
            type="file"
            accept="application/pdf,.pdf,.txt,.rtf,.html,.htm,text/plain,text/rtf,text/html"
            (change)="onFileSelected($event)"
            [disabled]="isUploading()"
            style="display: none;">

          <span class="error-help-text">or uncheck the requirement above</span>
        </div>
      </div>
    </div>
  </div>


  <!-- Agreement Preview -->
  <div class="template-preview">
    <div class="preview-header">
      <h3>Sample Consignment Agreement</h3>
      <div class="preview-description">
        <div class="view-mode-selector">
          <label class="radio-option">
            <input
              type="radio"
              name="viewMode"
              value="sample"
              [checked]="viewMode() === 'sample'"
              (change)="setViewMode('sample')">
            <span>View Sample</span>
          </label>
          <label class="radio-option">
            <input
              type="radio"
              name="viewMode"
              value="agreement"
              [checked]="viewMode() === 'agreement'"
              [disabled]="!hasCustomTemplate()"
              (change)="setViewMode('agreement')">
            <span>View Agreement</span>
          </label>
        </div>
        <div class="preview-actions">
          <button
            type="button"
            class="btn-icon-small"
            (click)="startEditing()"
            [disabled]="!isTemplateEditingEnabled()"
            title="Edit Agreement Template">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
            </svg>
          </button>
          <button type="button" class="btn-icon-small" (click)="downloadCurrentView()" [title]="getDownloadTooltip()">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
            </svg>
          </button>
          <button type="button" class="btn-icon-small" (click)="sendSampleAgreement()" [disabled]="isSaving()" title="Send Sample Agreement to Me">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
            </svg>
          </button>
          <label
            for="template-upload-preview"
            class="btn-icon-small"
            [class.disabled]="!isTemplateEditingEnabled()"
            title="Upload Agreement">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"/>
            </svg>
          </label>
          <input
            id="template-upload-preview"
            type="file"
            accept="application/pdf,.pdf,.txt,.rtf,.html,.htm,text/plain,text/rtf,text/html"
            (change)="onFileSelected($event)"
            [disabled]="isUploading() || !isTemplateEditingEnabled()"
            style="display: none;">
        </div>
      </div>
    </div>

    <div class="preview-content" *ngIf="!isEditing()">
      <!-- Show PDF download prompt for uploaded agreements -->
      <div *ngIf="viewMode() === 'agreement' && settings()?.agreementTemplateId; else textContent" class="pdf-download-prompt">
        <div class="pdf-info">
          <div class="pdf-icon">üìÑ</div>
          <h4>PDF Agreement Template</h4>
          <p>Your custom agreement template is saved as a PDF file.</p>
          <p><strong>Template ID:</strong> {{ settings()?.agreementTemplateId }}</p>
        </div>

        <div class="pdf-actions">
          <button type="button" class="btn-primary" (click)="downloadCurrentView()">
            <span>üì•</span>
            Download & View Agreement PDF
          </button>
          <p class="help-text">The PDF will download to your computer where you can view and print it.</p>
        </div>
      </div>

      <!-- Show text content for sample template or text-based agreements -->
      <ng-template #textContent>
        <pre class="template-preview-text">{{ getDisplayedContent() }}</pre>
      </ng-template>
    </div>

    <!-- Template Editor -->
    <div class="template-editor" *ngIf="isEditing()">
      <div class="editor-header">
        <h4>Edit Agreement Template</h4>
        <div class="editor-actions">
          <button type="button" class="btn-secondary" (click)="cancelEditing()">Cancel</button>
          <button type="button" class="btn-secondary" (click)="sendSampleAgreement()" [disabled]="isSaving()">
            {{ isSaving() ? 'Sending...' : 'Send Sample to Me' }}
          </button>
          <button type="button" class="btn-primary" (click)="generatePdfFromTemplate()" [disabled]="isSaving()">
            {{ isSaving() ? 'Generating...' : 'Generate PDF' }}
          </button>
        </div>
      </div>

      <textarea
        [(ngModel)]="templateContent"
        class="template-textarea"
        placeholder="Enter your agreement template text here..."
        rows="20">
      </textarea>

      <div class="meta-tags-help">
        <h5>Available Placeholders:</h5>
        <div class="tags-grid">
          <div *ngFor="let tag of metaTagsHelp" class="tag-item">
            <button type="button" class="tag-button" (click)="insertMetaTag(tag.tag)">
              {{ tag.tag }}
            </button>
            <span class="tag-description">{{ tag.description }}</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Legal Disclaimer -->
  <div class="legal-disclaimer">
    <div class="disclaimer-icon">‚öñÔ∏è</div>
    <div class="disclaimer-content">
      <h4>Legal Disclaimer</h4>
      <p>
        The sample template provided is for reference only and does not constitute legal advice.
        Consignment agreements may be subject to state and local laws. We strongly recommend
        having your agreement reviewed by a qualified attorney before use.
      </p>
    </div>
  </div>

  <!-- Messages -->
  <div class="messages" *ngIf="successMessage() || errorMessage()">
    <div *ngIf="successMessage()" class="message success">{{ successMessage() }}</div>
    <div *ngIf="errorMessage()" class="message error">{{ errorMessage() }}</div>
  </div>
</div>