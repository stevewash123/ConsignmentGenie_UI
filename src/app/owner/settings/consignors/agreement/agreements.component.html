<div class="agreement-template-editor">
  <div class="page-header">
    <h2>Consignment Agreement</h2>
    <p [innerHTML]="subtitleText"></p>

    <!-- Warning when template editing is disabled -->
    <div class="warning-panel" *ngIf="!isTemplateEditingEnabled()">
      <div class="warning-icon">⚠️</div>
      <div class="warning-content">
        Template editing is disabled because the agreement requirement is set to "No action required" in Consignor Onboarding settings.
        <a routerLink="/owner/settings/consignors/onboarding">Change onboarding settings</a> to enable template editing.
      </div>
    </div>

  </div>



  <!-- Agreement Preview -->
  <div class="template-preview">
    <div class="preview-header">
      <div class="header-content">
        <h3>Agreement Template</h3>
        <p class="header-subtext">Your agreement contract with keyword symbols</p>
      </div>
      <div class="preview-description">
        <div class="view-mode-selector">
          <label class="radio-option">
            <input
              type="radio"
              name="viewMode"
              value="sample"
              [checked]="viewMode() === 'sample'"
              (change)="setViewMode('sample')">
            <span>View Sample</span>
          </label>
          <label class="radio-option">
            <input
              type="radio"
              name="viewMode"
              value="agreement"
              [checked]="viewMode() === 'agreement'"
              [disabled]="!hasCustomTemplate()"
              (change)="setViewMode('agreement')">
            <span>View Agreement</span>
          </label>
          <label class="radio-option">
            <input
              type="radio"
              name="viewMode"
              value="keywords"
              [checked]="viewMode() === 'keywords'"
              (change)="setViewMode('keywords')">
            <span>View Key Words</span>
          </label>
        </div>
        <div class="preview-actions">
          <!-- Show edit button only when NOT in sample mode -->
          <button
            *ngIf="viewMode() !== 'sample'"
            type="button"
            class="btn-icon-small btn-secondary"
            (click)="startEditing()"
            [disabled]="!isTemplateEditingEnabled()"
            title="Edit Agreement Template">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
            </svg>
          </button>
          <button type="button" class="btn-icon-small btn-secondary" (click)="downloadCurrentView()" [title]="getDownloadTooltip()">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
            </svg>
          </button>
          <!-- Show upload button only when no custom template exists -->
          <ng-container *ngIf="!hasCustomTemplate()">
            <label
              for="template-upload-preview"
              class="btn-icon-small btn-primary"
              [class.disabled]="!isTemplateEditingEnabled()"
              title="Upload Agreement">
              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
              </svg>
            </label>
            <input
              id="template-upload-preview"
              type="file"
              accept="application/pdf,.pdf,.txt,.rtf,.html,.htm,text/plain,text/rtf,text/html"
              (change)="onFileSelected($event)"
              [disabled]="isUploading() || !isTemplateEditingEnabled()"
              style="display: none;">
          </ng-container>

          <!-- Show delete button when custom template exists and viewing agreement -->
          <ng-container *ngIf="hasCustomTemplate() && viewMode() === 'agreement'">
            <button
              type="button"
              class="btn-icon-small btn-danger btn-secondary"
              (click)="deleteTemplate()"
              [disabled]="isSaving()"
              title="Delete Agreement Template">
              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1-1H9a1 1 0 00-1 1v3M4 7h16"/>
              </svg>
            </button>
          </ng-container>
        </div>
      </div>
    </div>

    <div class="preview-content" *ngIf="!isEditing()">
      <!-- Show keywords list when in keywords mode -->
      <div *ngIf="viewMode() === 'keywords'" class="keywords-grid">
        <div class="keywords-column">
          <div *ngFor="let tag of firstHalfKeywords()" class="keyword-item">
            <span class="keyword-word">{{ tag.tag }}</span>
            <span class="keyword-description">{{ tag.description }}</span>
          </div>
        </div>
        <div class="keywords-column">
          <div *ngFor="let tag of secondHalfKeywords()" class="keyword-item">
            <span class="keyword-word">{{ tag.tag }}</span>
            <span class="keyword-description">{{ tag.description }}</span>
          </div>
        </div>
      </div>

      <!-- Show text content for sample and agreement modes -->
      <pre *ngIf="viewMode() !== 'keywords'" class="template-preview-text">{{ getDisplayedContent() }}</pre>
    </div>

    <!-- Template Editor -->
    <div class="template-editor" *ngIf="isEditing()">
      <div class="editor-header">
        <h4>Edit Agreement Template</h4>
        <div class="editor-actions">
          <button type="button" class="btn-secondary" (click)="cancelEditing()">Cancel</button>
          <button type="button" class="btn-primary" (click)="generatePdfFromTemplate()" [disabled]="isSaving()">
            {{ isSaving() ? 'Generating...' : 'Generate PDF' }}
          </button>
        </div>
      </div>

      <textarea
        [(ngModel)]="templateContent"
        class="template-textarea"
        placeholder="Enter your agreement template text here..."
        rows="20">
      </textarea>

      <div class="meta-tags-help">
        <h5>Available Placeholders:</h5>
        <div class="tags-grid">
          <div *ngFor="let tag of metaTagsHelp" class="tag-item">
            <button type="button" class="tag-button" (click)="insertMetaTag(tag.tag)">
              {{ tag.tag }}
            </button>
            <span class="tag-description">{{ tag.description }}</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Legal Disclaimer -->
  <div class="legal-disclaimer">
    <div class="disclaimer-icon">⚖️</div>
    <div class="disclaimer-content">
      <h4>Legal Disclaimer</h4>
      <p>
        The sample template provided is for reference only and does not constitute legal advice.
        Consignment agreements may be subject to state and local laws. We strongly recommend
        having your agreement reviewed by a qualified attorney before use.
      </p>
    </div>
  </div>

  <!-- Messages -->
  <div class="messages" *ngIf="successMessage() || errorMessage()">
    <div *ngIf="successMessage()" class="message success">{{ successMessage() }}</div>
    <div *ngIf="errorMessage()" class="message error">{{ errorMessage() }}</div>
  </div>
</div>