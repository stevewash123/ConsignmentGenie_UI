<div class="consignor-settings">
  <!-- Header -->
  <div class="settings-header">
    <h2>Consignor Settings</h2>
    <p>Configure default terms and policies for consignors</p>
  </div>

  <!-- Loading State -->
  <div *ngIf="isLoading()" class="loading-state">
    <div class="spinner"></div>
    <p>Loading settings...</p>
  </div>

  <!-- Content -->
  <div *ngIf="!isLoading() && settings()" class="settings-content">
    <!-- Tab Navigation -->
    <div class="tab-navigation">
      <button
        class="tab-button"
        [class.active]="activeTab() === 'defaults'"
        (click)="setActiveTab('defaults')">
        <span class="tab-icon">‚öôÔ∏è</span>
        <span class="tab-label">Defaults</span>
        <span class="tab-description">Split, periods, policies</span>
      </button>

      <button
        class="tab-button"
        [class.active]="activeTab() === 'agreements'"
        (click)="setActiveTab('agreements')">
        <span class="tab-icon">üìã</span>
        <span class="tab-label">Agreements</span>
        <span class="tab-description">Auto-send, requirements</span>
      </button>
    </div>

    <!-- Defaults Tab -->
    <div *ngIf="activeTab() === 'defaults'" class="tab-content">
      <form [formGroup]="defaultsForm" (ngSubmit)="saveDefaults()" class="settings-form">

        <!-- Commission Split -->
        <div class="form-section">
          <h3>Commission Split</h3>
          <p class="section-description">
            Default commission percentage for new consignors. This can be adjusted for individual consignors later.
          </p>

          <div class="split-display">
            <div class="split-input-group">
              <label for="defaultSplitPercent">Consignor receives:</label>
              <div class="percentage-input">
                <input
                  type="number"
                  id="defaultSplitPercent"
                  formControlName="defaultSplitPercent"
                  class="form-input percentage"
                  min="1"
                  max="99">
                <span class="percentage-symbol">%</span>
              </div>
            </div>

            <div class="split-visualization">
              <div class="split-bar">
                <div
                  class="consignor-portion"
                  [style.width.%]="defaultsForm.get('defaultSplitPercent')?.value">
                  {{ defaultsForm.get('defaultSplitPercent')?.value }}%
                </div>
                <div
                  class="shop-portion"
                  [style.width.%]="100 - defaultsForm.get('defaultSplitPercent')?.value">
                  {{ 100 - defaultsForm.get('defaultSplitPercent')?.value }}%
                </div>
              </div>
              <div class="split-labels">
                <span class="consignor-label">Consignor</span>
                <span class="shop-label">Shop</span>
              </div>
            </div>
          </div>

          <div *ngIf="defaultsForm.get('defaultSplitPercent')?.invalid && defaultsForm.get('defaultSplitPercent')?.touched" class="field-error">
            <span *ngIf="defaultsForm.get('defaultSplitPercent')?.errors?.['required']">Commission percentage is required</span>
            <span *ngIf="defaultsForm.get('defaultSplitPercent')?.errors?.['min']">Must be at least 1%</span>
            <span *ngIf="defaultsForm.get('defaultSplitPercent')?.errors?.['max']">Must be less than 100%</span>
          </div>
        </div>

        <!-- Time Periods -->
        <div class="form-section">
          <h3>Time Periods</h3>
          <p class="section-description">
            Default time periods for consignment and item retrieval.
          </p>

          <div class="time-periods-grid">
            <div class="form-group">
              <label for="consignmentPeriodDays">Consignment period (days)</label>
              <div class="input-with-suffix">
                <input
                  type="number"
                  id="consignmentPeriodDays"
                  formControlName="consignmentPeriodDays"
                  class="form-input"
                  min="1"
                  max="365">
                <span class="input-suffix">days</span>
              </div>
              <p class="field-help">How long items stay listed for sale</p>

              <div *ngIf="defaultsForm.get('consignmentPeriodDays')?.invalid && defaultsForm.get('consignmentPeriodDays')?.touched" class="field-error">
                <span *ngIf="defaultsForm.get('consignmentPeriodDays')?.errors?.['required']">Consignment period is required</span>
                <span *ngIf="defaultsForm.get('consignmentPeriodDays')?.errors?.['min']">Must be at least 1 day</span>
                <span *ngIf="defaultsForm.get('consignmentPeriodDays')?.errors?.['max']">Must be less than 365 days</span>
              </div>
            </div>

            <div class="form-group">
              <label for="retrievalPeriodDays">Retrieval period (days)</label>
              <div class="input-with-suffix">
                <input
                  type="number"
                  id="retrievalPeriodDays"
                  formControlName="retrievalPeriodDays"
                  class="form-input"
                  min="1"
                  max="90">
                <span class="input-suffix">days</span>
              </div>
              <p class="field-help">How long consignors have to pick up unsold items</p>

              <div *ngIf="defaultsForm.get('retrievalPeriodDays')?.invalid && defaultsForm.get('retrievalPeriodDays')?.touched" class="field-error">
                <span *ngIf="defaultsForm.get('retrievalPeriodDays')?.errors?.['required']">Retrieval period is required</span>
                <span *ngIf="defaultsForm.get('retrievalPeriodDays')?.errors?.['min']">Must be at least 1 day</span>
                <span *ngIf="defaultsForm.get('retrievalPeriodDays')?.errors?.['max']">Must be less than 90 days</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Unsold Item Policy -->
        <div class="form-section">
          <h3>Unsold Item Policy</h3>
          <p class="section-description">
            What happens to items not picked up after the retrieval period ends.
          </p>

          <div class="form-group">
            <label for="unsoldItemPolicy">After retrieval period, unsold items:</label>
            <select
              id="unsoldItemPolicy"
              formControlName="unsoldItemPolicy"
              class="form-select">
              <option *ngFor="let option of unsoldItemPolicyOptions" [value]="option.value">
                {{ option.label }}
              </option>
            </select>

            <div *ngIf="defaultsForm.get('unsoldItemPolicy')?.invalid && defaultsForm.get('unsoldItemPolicy')?.touched" class="field-error">
              <span *ngIf="defaultsForm.get('unsoldItemPolicy')?.errors?.['required']">Please select a policy for unsold items</span>
            </div>
          </div>
        </div>

        <!-- Save Button -->
        <div class="form-actions">
          <button
            type="submit"
            class="btn-primary"
            [disabled]="defaultsForm.invalid || isSaving()">
            <span *ngIf="isSaving()">Saving...</span>
            <span *ngIf="!isSaving()">Save Default Settings</span>
          </button>
        </div>
      </form>
    </div>

    <!-- Agreements Tab -->
    <div *ngIf="activeTab() === 'agreements'" class="tab-content">
      <form [formGroup]="agreementsForm" (ngSubmit)="saveAgreements()" class="settings-form">

        <!-- Agreement Template Section -->
        <div class="form-section">
          <h3>Agreement Template</h3>
          <p class="section-description">
            Manage your consignment agreement template that gets sent to consignors.
          </p>

          <div class="template-status">
            <div class="status-indicator">
              <span class="status-icon" [class]="settings()?.agreementTemplateCustomized ? 'customized' : 'sample'">
                {{ settings()?.agreementTemplateCustomized ? '‚úÖ' : '‚ö†Ô∏è' }}
              </span>
              <div class="status-text">
                <span class="status-title">
                  {{ settings()?.agreementTemplateCustomized ? 'Custom template' : 'Sample template (not customized)' }}
                </span>
                <p class="status-description">
                  {{ settings()?.agreementTemplateCustomized
                    ? 'Your template is ready for use'
                    : 'You must customize the template before using auto-send' }}
                </p>
              </div>
            </div>

            <div class="template-actions">
              <button type="button" class="btn-secondary" (click)="editTemplate()">
                Edit Template
              </button>
              <button type="button" class="btn-secondary" (click)="downloadTemplate()">
                Download Template
              </button>
            </div>
          </div>
        </div>

        <!-- Registration Behavior -->
        <div class="form-section">
          <h3>Registration Behavior</h3>
          <p class="section-description">
            Configure what happens when new consignors register.
          </p>

          <div class="toggle-option">
            <label class="toggle-label">
              <input
                type="checkbox"
                formControlName="autoSendAgreementOnRegistration"
                class="toggle-input">
              <div class="toggle-switch"></div>
              <div class="toggle-content">
                <span class="toggle-title">Auto-send agreement when consignor registers</span>
                <p class="toggle-description">
                  When enabled, newly registered consignors automatically receive your agreement via email.
                </p>
              </div>
            </label>

            <div *ngIf="agreementsForm.get('autoSendAgreementOnRegistration')?.value && !settings()?.agreementTemplateCustomized"
                 class="warning-banner">
              <span class="warning-icon">‚ö†Ô∏è</span>
              <span class="warning-text">You must customize your template before enabling this.</span>
            </div>
          </div>
        </div>

        <!-- Requirements -->
        <div class="form-section">
          <h3>Requirements</h3>
          <p class="section-description">
            Control whether signed agreements are required before consignors can submit items.
          </p>

          <div class="toggle-option">
            <label class="toggle-label">
              <input
                type="checkbox"
                formControlName="requireAgreementBeforeItems"
                class="toggle-input">
              <div class="toggle-switch"></div>
              <div class="toggle-content">
                <span class="toggle-title">Require signed agreement before consignor can submit items</span>
                <p class="toggle-description">
                  When enabled, consignors see "Agreement Required" on their dashboard until you mark their agreement as on file.
                </p>
              </div>
            </label>
          </div>
        </div>

        <!-- Agreement Flow Status -->
        <div *ngIf="getAgreementFlowStatus() !== 'not-configured'" class="form-section">
          <div class="flow-status" [class]="getAgreementFlowStatus()">
            <div *ngIf="getAgreementFlowStatus() === 'configured'" class="status-banner success">
              <span class="status-icon">‚úÖ</span>
              <div class="status-content">
                <h4>Agreement Flow Configured</h4>
                <ul class="status-features">
                  <li>Agreements auto-sent on registration</li>
                  <li>Item submission blocked until agreement on file</li>
                  <li>You'll mark "Contract on file" after receiving signed copy</li>
                </ul>
              </div>
            </div>

            <div *ngIf="getAgreementFlowStatus() === 'template-not-ready'" class="status-banner warning">
              <span class="status-icon">‚ö†Ô∏è</span>
              <div class="status-content">
                <h4>Template Not Ready</h4>
                <p>Auto-send is enabled, but your agreement template still has sample content. Agreements won't be sent until you customize your template.</p>
                <button type="button" class="btn-secondary" (click)="editTemplate()">
                  Edit Template
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Save Button -->
        <div class="form-actions">
          <button
            type="submit"
            class="btn-primary"
            [disabled]="agreementsForm.invalid || isSaving()">
            <span *ngIf="isSaving()">Saving...</span>
            <span *ngIf="!isSaving()">Save Agreement Settings</span>
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Messages -->
  <div class="messages" *ngIf="successMessage() || errorMessage()">
    <div *ngIf="successMessage()" class="message success">
      {{ successMessage() }}
    </div>
    <div *ngIf="errorMessage()" class="message error">
      {{ errorMessage() }}
    </div>
  </div>
</div>

<style>
.consignor-settings {
  padding: 2rem;
  max-width: 1000px;
  margin: 0 auto;
}

.settings-header {
  margin-bottom: 2rem;
  border-bottom: 1px solid #e5e7eb;
  padding-bottom: 1rem;
}

.settings-header h2 {
  font-size: 1.875rem;
  font-weight: 700;
  color: #111827;
  margin-bottom: 0.5rem;
}

.settings-header p {
  color: #6b7280;
  font-size: 1rem;
}

/* Loading State */
.loading-state {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 3rem;
  gap: 1rem;
}

.spinner {
  width: 32px;
  height: 32px;
  border: 3px solid #e5e7eb;
  border-top: 3px solid #3b82f6;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* Tab Navigation */
.tab-navigation {
  display: flex;
  gap: 0.5rem;
  margin-bottom: 2rem;
  border-bottom: 1px solid #e5e7eb;
}

.tab-button {
  display: flex;
  flex-direction: column;
  align-items: flex-start;
  gap: 0.25rem;
  padding: 1rem 1.5rem;
  background: none;
  border: none;
  border-bottom: 3px solid transparent;
  cursor: pointer;
  transition: all 0.2s ease;
  flex: 1;
}

.tab-button:hover {
  background: #f9fafb;
  border-bottom-color: #d1d5db;
}

.tab-button.active {
  background: #eff6ff;
  border-bottom-color: #3b82f6;
}

.tab-icon {
  font-size: 1.25rem;
}

.tab-label {
  font-weight: 600;
  color: #111827;
}

.tab-description {
  font-size: 0.875rem;
  color: #6b7280;
}

.tab-button.active .tab-label {
  color: #1d4ed8;
}

.tab-button.active .tab-description {
  color: #3b82f6;
}

/* Form Styles */
.settings-form {
  display: flex;
  flex-direction: column;
  gap: 2rem;
}

.form-section {
  padding-bottom: 2rem;
  border-bottom: 1px solid #e5e7eb;
}

.form-section:last-child {
  border-bottom: none;
  padding-bottom: 0;
}

.form-section h3 {
  font-size: 1.25rem;
  font-weight: 600;
  color: #111827;
  margin-bottom: 0.5rem;
}

.section-description {
  color: #6b7280;
  margin-bottom: 1.5rem;
  line-height: 1.5;
}

.form-group {
  margin-bottom: 1.5rem;
}

.form-group:last-child {
  margin-bottom: 0;
}

.form-group label {
  display: block;
  font-weight: 500;
  color: #374151;
  margin-bottom: 0.5rem;
  font-size: 0.875rem;
}

.form-input, .form-select {
  width: 100%;
  padding: 0.75rem;
  border: 1px solid #d1d5db;
  border-radius: 6px;
  font-size: 1rem;
  transition: border-color 0.2s ease, box-shadow 0.2s ease;
  box-sizing: border-box;
}

.form-input:focus, .form-select:focus {
  outline: none;
  border-color: #3b82f6;
  box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.field-help {
  font-size: 0.75rem;
  color: #6b7280;
  margin-top: 0.25rem;
}

.field-error {
  color: #dc2626;
  font-size: 0.75rem;
  margin-top: 0.25rem;
}

/* Commission Split Specific */
.split-display {
  display: flex;
  flex-direction: column;
  gap: 1.5rem;
}

.split-input-group {
  display: flex;
  align-items: center;
  gap: 1rem;
}

.percentage-input {
  position: relative;
  width: 120px;
}

.percentage-input .form-input {
  padding-right: 2.5rem;
}

.percentage-symbol {
  position: absolute;
  right: 0.75rem;
  top: 50%;
  transform: translateY(-50%);
  color: #6b7280;
  font-weight: 500;
}

.split-visualization {
  background: #f9fafb;
  border: 1px solid #e5e7eb;
  border-radius: 8px;
  padding: 1.5rem;
}

.split-bar {
  display: flex;
  height: 2rem;
  border-radius: 6px;
  overflow: hidden;
  margin-bottom: 0.75rem;
}

.consignor-portion {
  background: #3b82f6;
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 600;
  font-size: 0.875rem;
  transition: width 0.3s ease;
}

.shop-portion {
  background: #6b7280;
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 600;
  font-size: 0.875rem;
  transition: width 0.3s ease;
}

.split-labels {
  display: flex;
  justify-content: space-between;
  font-size: 0.75rem;
  color: #6b7280;
}

/* Time Periods Grid */
.time-periods-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 1.5rem;
}

.input-with-suffix {
  position: relative;
  display: flex;
  align-items: center;
}

.input-with-suffix .form-input {
  flex: 1;
  padding-right: 4rem;
}

.input-suffix {
  position: absolute;
  right: 0.75rem;
  color: #6b7280;
  font-size: 0.875rem;
  pointer-events: none;
}

/* Toggle Options */
.toggle-option {
  margin-bottom: 1.5rem;
}

.toggle-label {
  display: flex;
  align-items: flex-start;
  gap: 1rem;
  cursor: pointer;
  padding: 1rem;
  border: 1px solid #e5e7eb;
  border-radius: 8px;
  transition: all 0.2s ease;
}

.toggle-label:hover {
  border-color: #3b82f6;
  background: #f9fafb;
}

.toggle-input {
  display: none;
}

.toggle-switch {
  width: 44px;
  height: 24px;
  background: #d1d5db;
  border-radius: 12px;
  position: relative;
  transition: background-color 0.2s;
  flex-shrink: 0;
  margin-top: 2px;
}

.toggle-switch::after {
  content: '';
  position: absolute;
  width: 20px;
  height: 20px;
  background: white;
  border-radius: 50%;
  top: 2px;
  left: 2px;
  transition: transform 0.2s;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

.toggle-input:checked + .toggle-switch {
  background: #3b82f6;
}

.toggle-input:checked + .toggle-switch::after {
  transform: translateX(20px);
}

.toggle-content {
  flex: 1;
}

.toggle-title {
  display: block;
  font-weight: 600;
  color: #111827;
  margin-bottom: 0.25rem;
}

.toggle-description {
  color: #6b7280;
  font-size: 0.875rem;
  line-height: 1.4;
}

/* Template Status */
.template-status {
  background: #f9fafb;
  border: 1px solid #e5e7eb;
  border-radius: 8px;
  padding: 1.5rem;
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  gap: 1rem;
}

.status-indicator {
  display: flex;
  align-items: flex-start;
  gap: 1rem;
  flex: 1;
}

.status-icon {
  font-size: 1.5rem;
  flex-shrink: 0;
}

.status-text {
  flex: 1;
}

.status-title {
  display: block;
  font-weight: 600;
  color: #111827;
  margin-bottom: 0.25rem;
}

.status-description {
  color: #6b7280;
  font-size: 0.875rem;
  margin: 0;
}

.template-actions {
  display: flex;
  gap: 0.5rem;
  flex-shrink: 0;
}

/* Warning Banner */
.warning-banner {
  background: #fef3cd;
  border: 1px solid #fbbf24;
  border-radius: 6px;
  padding: 0.75rem 1rem;
  margin-top: 0.75rem;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.warning-icon {
  color: #d97706;
}

.warning-text {
  color: #92400e;
  font-size: 0.875rem;
  font-weight: 500;
}

/* Flow Status */
.flow-status {
  margin-top: 1rem;
}

.status-banner {
  border-radius: 8px;
  padding: 1.5rem;
  display: flex;
  align-items: flex-start;
  gap: 1rem;
}

.status-banner.success {
  background: #ecfdf5;
  border: 1px solid #a7f3d0;
}

.status-banner.warning {
  background: #fef3cd;
  border: 1px solid #fbbf24;
}

.status-banner .status-icon {
  font-size: 1.5rem;
  flex-shrink: 0;
}

.status-content {
  flex: 1;
}

.status-content h4 {
  font-size: 1.125rem;
  font-weight: 600;
  margin-bottom: 0.5rem;
}

.success .status-content h4 {
  color: #065f46;
}

.warning .status-content h4 {
  color: #92400e;
}

.status-content p {
  margin: 0;
  line-height: 1.4;
}

.success .status-content p {
  color: #047857;
}

.warning .status-content p {
  color: #92400e;
}

.status-features {
  list-style: none;
  padding: 0;
  margin: 0.5rem 0 0 0;
  display: flex;
  flex-direction: column;
  gap: 0.25rem;
}

.status-features li {
  color: #047857;
  font-size: 0.875rem;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.status-features li::before {
  content: '‚Ä¢';
  color: #10b981;
}

/* Buttons */
.btn-primary, .btn-secondary {
  padding: 0.75rem 1.5rem;
  border-radius: 6px;
  font-weight: 500;
  font-size: 0.875rem;
  cursor: pointer;
  border: 1px solid;
  transition: all 0.2s ease;
  text-decoration: none;
  display: inline-block;
  text-align: center;
}

.btn-primary {
  background: #3b82f6;
  color: white;
  border-color: #3b82f6;
}

.btn-primary:hover:not(:disabled) {
  background: #2563eb;
  border-color: #2563eb;
}

.btn-primary:disabled {
  background: #9ca3af;
  border-color: #9ca3af;
  cursor: not-allowed;
}

.btn-secondary {
  background: white;
  color: #374151;
  border-color: #d1d5db;
}

.btn-secondary:hover {
  background: #f9fafb;
}

.form-actions {
  display: flex;
  justify-content: flex-end;
  gap: 1rem;
  padding-top: 2rem;
  border-top: 1px solid #e5e7eb;
}

/* Messages */
.messages {
  margin-top: 2rem;
}

.message {
  padding: 0.75rem 1rem;
  border-radius: 6px;
  font-weight: 500;
  margin-bottom: 0.5rem;
}

.message.success {
  background: #ecfdf5;
  color: #059669;
  border: 1px solid #a7f3d0;
}

.message.error {
  background: #fef2f2;
  color: #dc2626;
  border: 1px solid #fecaca;
}

/* Responsive */
@media (max-width: 768px) {
  .consignor-settings {
    padding: 1rem;
  }

  .tab-navigation {
    flex-direction: column;
    gap: 0;
  }

  .tab-button {
    border-bottom: 1px solid #e5e7eb;
    border-radius: 0;
  }

  .tab-button:last-child {
    border-bottom: none;
  }

  .tab-button.active {
    border-left: 3px solid #3b82f6;
    border-bottom-color: #e5e7eb;
  }

  .time-periods-grid {
    grid-template-columns: 1fr;
  }

  .split-input-group {
    flex-direction: column;
    align-items: flex-start;
  }

  .template-status {
    flex-direction: column;
    gap: 1rem;
  }

  .template-actions {
    align-self: stretch;
  }

  .template-actions {
    flex-direction: column;
  }

  .status-banner {
    flex-direction: column;
    gap: 0.75rem;
  }

  .form-actions {
    flex-direction: column;
  }
}
</style>