<div class="dropoff-detail-page">
  <!-- Header -->
  <div class="page-header">
    <div class="header-content">
      <a (click)="back()" class="back-link">‚Üê Back to Manifests</a>
      <h1>Drop-off Manifest Detail</h1>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="isLoading" class="loading">
    <div class="loading-spinner"></div>
    <p>Loading manifest details...</p>
  </div>

  <!-- Error State -->
  <div *ngIf="error && !isLoading" class="error-state">
    <p>{{ error }}</p>
    <button class="retry-button" (click)="back()">Back to List</button>
  </div>

  <!-- Request Detail -->
  <div *ngIf="!isLoading && !error && request" class="content-area">

    <!-- Consolidated Information -->
    <div class="info-card">
      <div class="card-header">
        <span class="badge status-badge" [ngClass]="getStatusBadgeClass(request.status)">
          {{ request.status | titlecase }}
        </span>
        <div class="header-center">
          <h2>{{ request.consignor.firstName }} {{ request.consignor.lastName }}</h2>
        </div>
        <div class="header-dates">
          <div><span class="label">Submitted:</span> {{ formatDate(request.createdAt) }}</div>
          <div *ngIf="request.receivedAt">
            <span class="label">Received:</span> {{ formatDate(request.receivedAt) }}
          </div>
          <div *ngIf="request.rejectedAt">
            <span class="label">Rejected:</span> {{ formatDate(request.rejectedAt) }}
          </div>
          <div *ngIf="request.reopenedAt">
            <span class="label">Reopened:</span> {{ formatDate(request.reopenedAt) }}
          </div>
          <div *ngIf="request.importedAt">
            <span class="label">Imported:</span> {{ formatDate(request.importedAt) }}
          </div>
        </div>
      </div>

      <div class="stats-grid">
        <div class="stat-item">
          <div class="stat-label">Total Items</div>
          <div class="stat-value">{{ request.itemCount }}</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">Suggested Total</div>
          <div class="stat-value">{{ request.suggestedTotal | currency }}</div>
        </div>
        <div class="stat-item" *ngIf="request.minimumTotal">
          <div class="stat-label">Minimum Total</div>
          <div class="stat-value">{{ request.minimumTotal | currency }}</div>
        </div>
        <div class="stat-item" *ngIf="request.plannedDate">
          <div class="stat-label">Planned Drop-off</div>
          <div class="stat-value">
            {{ formatDate(request.plannedDate) }}
            <div *ngIf="request.plannedTimeSlot" class="stat-sub">
              {{ request.plannedTimeSlot }}
            </div>
          </div>
        </div>
      </div>

      <!-- Consolidated Contact Info -->
      <div class="contact-info-section">
        <div class="info-grid">
          <div class="info-item" *ngIf="request.consignor.email">
            <span class="info-label">Email:</span>
            <span class="info-value">{{ request.consignor.email }}</span>
          </div>
          <div class="info-item" *ngIf="request.consignor.phone">
            <span class="info-label">Phone:</span>
            <span class="info-value">{{ request.consignor.phone }}</span>
          </div>
          <div class="info-item" *ngIf="request.consignor.address">
            <span class="info-label">Address:</span>
            <span class="info-value">
              <div>{{ request.consignor.address }}</div>
              <div *ngIf="request.consignor.city || request.consignor.state || request.consignor.zip">
                {{ request.consignor.city }}<span *ngIf="request.consignor.city && request.consignor.state">, </span>{{ request.consignor.state }} {{ request.consignor.zip }}
              </div>
            </span>
          </div>
        </div>
      </div>
    </div>

    <!-- Items List -->
    <div class="items-section">
      <h3>Items ({{ request.items.length }})</h3>
      <div class="items-table-container">
        <table class="items-table">
          <tbody>
            <tr *ngFor="let item of request.items">
              <td>
                <div class="item-photo">
                  <img *ngIf="item.imageUrl" [src]="item.imageUrl" [alt]="item.name" class="item-image">
                  <div *ngIf="!item.imageUrl" class="no-image">No Photo</div>
                </div>
              </td>
              <td class="font-medium">{{ item.name }}</td>
              <td class="stacked-cell">
                <div class="cell-line">{{ item.category || '-' }}</div>
                <div class="cell-line-sub">{{ item.brand || '-' }}</div>
              </td>
              <td class="stacked-cell">
                <div class="cell-line"><span class="price-label">Suggested:</span> {{ item.suggestedPrice | currency }}</div>
                <div class="cell-line-sub"><span class="price-label">Minimum:</span> {{ item.minimumPrice ? (item.minimumPrice | currency) : '-' }}</div>
              </td>
              <td [title]="item.notes">{{ item.notes || '-' }}</td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Action Button -->
      <div class="action-button-section">
        <div class="button-group">
          <button
            *ngIf="canMarkAsReceived()"
            (click)="markAsReceived()"
            [disabled]="isUpdating"
            class="btn-primary">
            <span *ngIf="isUpdating" class="loading-spinner" style="width: 16px; height: 16px; margin-right: 0.5rem;"></span>
            Move to Pending
          </button>

          <button
            *ngIf="canImportToInventory()"
            (click)="importToInventory()"
            [disabled]="isUpdating"
            class="btn-success">
            <span *ngIf="isUpdating" class="loading-spinner" style="width: 16px; height: 16px; margin-right: 0.5rem;"></span>
            Import to Inventory
          </button>

          <button
            *ngIf="canReject()"
            (click)="showRejectDropoffModal()"
            [disabled]="isUpdating"
            class="btn-error">
            Reject Manifest
          </button>

          <button
            *ngIf="canReopen()"
            (click)="reopenDropoff()"
            [disabled]="isReopening"
            class="btn-primary">
            <span *ngIf="isReopening" class="loading-spinner" style="width: 16px; height: 16px; margin-right: 0.5rem;"></span>
            Reopen Manifest
          </button>
        </div>

        <div *ngIf="!canMarkAsReceived() && !canImportToInventory() && !canReject() && !canReopen()" style="font-size: 0.875rem; color: var(--color-text-muted); display: flex; align-items: center;">
          <svg style="width: 16px; height: 16px; margin-right: 0.25rem;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
          No actions available for {{ request.status }} requests
        </div>
      </div>
    </div>

    <!-- Rejection Information -->
    <div class="info-card" *ngIf="request.status === 'rejected' && request.rejectionReason">
      <h3>Rejection Reason</h3>
      <div style="background: var(--color-error-light); padding: 0.75rem; border-radius: var(--border-radius-md); font-size: 0.875rem; border-left: 4px solid var(--color-error);">
        {{ request.rejectionReason }}
      </div>
    </div>

    <!-- Messages -->
    <div class="info-card" *ngIf="request.message">
      <h3>Consignor Message</h3>
      <div style="background: var(--color-info-light); padding: 0.75rem; border-radius: var(--border-radius-md); font-size: 0.875rem;">{{ request.message }}</div>
    </div>

  </div>

  <!-- Rejection Modal -->
  <div *ngIf="showRejectModal" class="modal-overlay" (click)="closeRejectModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Reject Manifest</h3>
        <button (click)="closeRejectModal()" class="close-button">&times;</button>
      </div>

      <div class="modal-body">
        <p>Are you sure you want to reject this manifest? This will notify the consignor and change the status to "Rejected".</p>

        <div class="form-group">
          <label for="rejectionReason">Rejection Reason <span class="required">*</span></label>
          <textarea
            id="rejectionReason"
            [(ngModel)]="rejectionReason"
            placeholder="Please provide a reason for rejecting this manifest..."
            rows="4"
            maxlength="500"
            class="form-control">
          </textarea>
          <div class="character-count">{{ rejectionReason.length }}/500</div>
        </div>
      </div>

      <div class="modal-footer">
        <button (click)="closeRejectModal()" class="btn-secondary">Cancel</button>
        <button
          (click)="rejectDropoff()"
          [disabled]="!rejectionReason.trim() || isRejecting"
          class="btn-error">
          <span *ngIf="isRejecting" class="loading-spinner" style="width: 16px; height: 16px; margin-right: 0.5rem;"></span>
          Reject Manifest
        </button>
      </div>
    </div>
  </div>
</div>