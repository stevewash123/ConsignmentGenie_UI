<div class="modal-overlay" *ngIf="isOpen" (click)="close()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <!-- Header -->
    <div class="modal-header">
      <h2 class="modal-title">üì¶ Import Items</h2>
      <button class="close-button" (click)="close()" type="button">√ó</button>
    </div>

    <!-- Body -->
    <div class="modal-body">
      <!-- Upload Section -->
      <div
        class="upload-section"
        [class.dragover]="isDragOver()"
        (dragover)="onDragOver($event)"
        (dragleave)="onDragLeave($event)"
        (drop)="onDrop($event)"
        *ngIf="!selectedFile()">

        <div class="upload-icon">üìÑ</div>
        <div class="upload-title">Import Items from CSV</div>
        <div class="upload-description">
          Drag and drop your CSV file here, or click to browse for a file.<br>
          Make sure your CSV matches our template format.
        </div>

        <div class="upload-buttons">
          <button class="btn btn-primary" (click)="fileInput.click()">
            Choose File
          </button>
          <button class="btn btn-secondary" (click)="downloadTemplate()">
            üì• Download Template
          </button>
        </div>

        <input
          #fileInput
          type="file"
          accept=".csv"
          class="file-input"
          (change)="onFileSelected($event)">
      </div>

      <!-- Processing State -->
      <div *ngIf="isProcessing()" class="upload-section">
        <div class="upload-icon">‚è≥</div>
        <div class="upload-title">Processing CSV...</div>
        <div class="upload-description">Please wait while we validate your data.</div>
      </div>

      <!-- Preview Section -->
      <div class="preview-section" *ngIf="selectedFile() && !isProcessing() && summary()">
        <!-- File Info -->
        <div style="margin-bottom: 1rem;">
          <strong>File:</strong> {{ selectedFile()!.name }}
          <button class="btn btn-secondary" style="margin-left: 1rem; font-size: 0.75rem; padding: 0.25rem 0.5rem;" (click)="reset(); selectedFile.set(null)">
            Choose Different File
          </button>
        </div>

        <!-- Summary -->
        <div class="summary-box">
          <div class="summary-row">
            <span class="summary-label">Total Rows:</span>
            <span class="summary-value">{{ summary()!.totalRows }}</span>
          </div>
          <div class="summary-row">
            <span class="summary-label">Valid Items:</span>
            <span class="summary-value valid-count">{{ summary()!.validRows }}</span>
          </div>
          <div class="summary-row">
            <span class="summary-label">Errors:</span>
            <span class="summary-value error-count">{{ summary()!.errorRows }}</span>
          </div>
        </div>

        <!-- Pagination Info -->
        <div class="pagination-info" *ngIf="paginatedData().totalItems > pageSize()">
          Showing {{ paginatedData().startIndex + 1 }}-{{ paginatedData().endIndex }} of {{ paginatedData().totalItems }} items
        </div>

        <!-- Preview Table -->
        <div class="table-container">
          <table class="preview-table">
            <thead>
              <tr>
                <th class="compact-header">Status</th>
                <th class="compact-header">Row</th>
                <th class="compact-header">Name</th>
                <th class="compact-header">Price</th>
                <th class="compact-header">Consignor #</th>
                <th class="compact-header">Category</th>
                <th class="compact-header">Condition</th>
                <th class="compact-header">Errors</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let row of paginatedData().items; trackBy: trackByRowNumber"
                  [class]="row.isValid ? 'row-valid' : 'row-error'">
                <td class="status-cell compact-cell">
                  <span [class]="row.isValid ? 'status-valid' : 'status-error'" class="compact-icon">
                    {{ row.isValid ? '‚úÖ' : '‚ùå' }}
                  </span>
                </td>
                <td class="compact-cell">{{ row.rowNumber }}</td>
                <td class="compact-cell">{{ row.data.name }}</td>
                <td class="compact-cell">{{ row.data.price }}</td>
                <td class="compact-cell">{{ row.data.consignorNumber }}</td>
                <td class="compact-cell">{{ row.data.category }}</td>
                <td class="compact-cell">{{ row.data.condition }}</td>
                <td class="compact-cell">
                  <ul class="error-list" *ngIf="!row.isValid">
                    <li class="error-item" *ngFor="let error of row.errors">{{ error }}</li>
                  </ul>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Pagination Controls -->
        <div class="pagination-controls" *ngIf="paginatedData().totalPages > 1">
          <button class="btn btn-sm"
                  [disabled]="currentPage() <= 1"
                  (click)="previousPage()">Previous</button>
          <span class="page-info">Page {{ currentPage() }} of {{ paginatedData().totalPages }}</span>
          <button class="btn btn-sm"
                  [disabled]="currentPage() >= paginatedData().totalPages"
                  (click)="nextPage()">Next</button>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <div class="modal-footer" *ngIf="selectedFile() && !isProcessing() && summary()">
      <div class="footer-left">
        <button
          class="btn btn-secondary"
          (click)="downloadErrorReport()"
          *ngIf="summary()!.errorRows > 0">
          üì• Download Error Report
        </button>
      </div>

      <div class="footer-right">
        <button class="btn btn-secondary" (click)="close()" [disabled]="isImporting()">Cancel</button>
        <button
          class="btn btn-success"
          (click)="importValidItems()"
          [disabled]="!hasValidItems() || isImporting()">
          <span *ngIf="isImporting()">‚è≥ Importing...</span>
          <span *ngIf="!isImporting()">Import {{ summary()!.validRows }} Valid Items</span>
        </button>
      </div>
    </div>
  </div>
</div>