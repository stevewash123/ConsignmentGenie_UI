<div class="detail-page" *ngIf="!isLoading(); else loading">

    <!-- Page Header -->
    <div class="page-header">
      <div class="header-content">
        <button class="btn-secondary" (click)="goBack()" title="Go back to previous page">
          ‚Üê Back
        </button>
      </div>
      <div class="header-actions">
        <div class="dropdown">
          <button class="btn-primary dropdown-toggle" type="button">
            Actions ‚ñº
          </button>
          <div class="dropdown-menu">
            <button class="dropdown-item" (click)="editItem()">
              ‚úèÔ∏è Edit Item
            </button>
            <button
              class="dropdown-item"
              *ngIf="item()?.status === 'Available'"
              (click)="openPriceChangeModal()"
            >
              üí∞ Change Price
            </button>
            <div class="dropdown-divider"></div>
            <button class="dropdown-item">
              üè∑Ô∏è Print Label
            </button>
            <button class="dropdown-item">
              üì§ Remove from Inventory
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Entity Title Row -->
    <div class="entity-header" *ngIf="item()">
      <h1>{{ item()!.title }}</h1>
      <div class="entity-meta">
        <span class="badge" [ngClass]="getStatusClass(item()!.status)">
          {{ item()!.status }}
        </span>
        <span class="meta-id">SKU: {{ item()!.sku }}</span>
      </div>
    </div>

    <!-- Main Content Card -->
    <div class="detail-card" *ngIf="item()">

      <!-- Stats Bar -->
      <div class="stats-bar">
        <div class="stat-item">
          <span class="stat-value">{{ formatCurrency(item()!.price) }}</span>
          <span class="stat-label">Current Price</span>
        </div>
        <div class="stat-item">
          <span class="stat-value">{{ formatCurrency(getCorrectConsignorAmount(item()!)) }}</span>
          <span class="stat-label">Consignor Split</span>
        </div>
        <div class="stat-item">
          <span class="stat-value">{{ formatCurrency(getCorrectShopAmount(item()!)) }}</span>
          <span class="stat-label">Shop Split</span>
        </div>
        <div class="stat-item" [ngClass]="getExpirationStatusClass()">
          <span class="stat-value">{{ getExpirationDisplayText() }}</span>
          <span class="stat-label">Expiration</span>
        </div>
        <div class="stat-item">
          <span class="stat-value">{{ formatCommissionRate(item()!.commissionRate) }}%</span>
          <span class="stat-label">Commission</span>
        </div>
      </div>

      <!-- Info Sections -->
      <div class="info-container">
        <div class="info-row">
          <!-- Item Details -->
          <div class="info-section">
            <h3>Item Details</h3>
            <div class="info-grid">
              <div class="info-item" *ngIf="item()!.category">
                <span class="info-label">Category</span>
                <span class="info-value">{{ item()!.category }}</span>
              </div>
              <div class="info-item" *ngIf="item()!.brand">
                <span class="info-label">Brand</span>
                <span class="info-value">{{ item()!.brand }}</span>
              </div>
              <div class="info-item">
                <span class="info-label">Condition</span>
                <span class="info-value condition-badge" [ngClass]="getConditionClass(item()!.condition)">
                  {{ getConditionLabel(item()!.condition) }}
                </span>
              </div>
              <div class="info-item" *ngIf="item()!.size">
                <span class="info-label">Size</span>
                <span class="info-value">{{ item()!.size }}</span>
              </div>
              <div class="info-item" *ngIf="item()!.color">
                <span class="info-label">Color</span>
                <span class="info-value">{{ item()!.color }}</span>
              </div>
              <div class="info-item" *ngIf="item()!.barcode">
                <span class="info-label">Barcode</span>
                <span class="info-value cell-mono">{{ item()!.barcode }}</span>
              </div>
              <div class="info-item">
                <span class="info-label">Received</span>
                <span class="info-value">{{ item()!.receivedDate | date:'MMM d, y' }}</span>
              </div>
              <div class="info-item" *ngIf="item()!.expirationDate">
                <span class="info-label">Expiration</span>
                <span class="info-value">{{ item()!.expirationDate | date:'MMM d, y' }}</span>
              </div>
            </div>
          </div>

          <!-- Consignor Information -->
          <div class="info-section">
            <h3>Consignor Information</h3>
            <div class="info-grid">
              <div class="info-item">
                <span class="info-label">Consignor</span>
                <span class="info-value consignor-link clickable" (click)="viewConsignor()">
                  {{ item()!.consignorName }}
                </span>
              </div>
              <div class="info-item">
                <span class="info-label">Commission Rate</span>
                <span class="info-value">{{ formatCommissionRate(item()!.commissionRate) }}%</span>
              </div>
              <div class="info-item" *ngIf="item()!.originalPrice">
                <span class="info-label">Original Price</span>
                <span class="info-value">{{ formatCurrency(item()!.originalPrice) }}</span>
              </div>
              <div class="info-item" *ngIf="item()!.minimumPrice">
                <span class="info-label">Minimum Price</span>
                <span class="info-value">{{ formatCurrency(item()!.minimumPrice) }}</span>
              </div>
              <div class="info-item" *ngIf="item()!.location">
                <span class="info-label">Location</span>
                <span class="info-value">{{ item()!.location }}</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Description Section -->
        <div class="info-section full-width" *ngIf="item()!.description">
          <h3>Description</h3>
          <div class="notes-display">{{ item()!.description }}</div>
        </div>

        <!-- Materials/Measurements Section -->
        <div class="info-section full-width" *ngIf="item()!.materials || item()!.measurements">
          <h3>Additional Details</h3>
          <div class="info-grid">
            <div class="info-item" *ngIf="item()!.materials">
              <span class="info-label">Materials</span>
              <span class="info-value">{{ item()!.materials }}</span>
            </div>
            <div class="info-item" *ngIf="item()!.measurements">
              <span class="info-label">Measurements</span>
              <span class="info-value">{{ item()!.measurements }}</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Item History -->
      <div class="history-section">
        <h3>Item History</h3>
        <div class="history-table" *ngIf="itemHistory().length > 0">
          <div class="history-row" *ngFor="let activity of itemHistory()">
            <span class="history-icon">{{ getHistoryIcon(activity.type) }}</span>
            <span class="history-desc">{{ activity.description }}</span>
            <span class="history-date">{{ activity.date | date:'short' }}</span>
            <span class="history-amount" *ngIf="activity.amount">
              {{ activity.amount | currency:'USD':'symbol':'1.2-2' }}
            </span>
            <span class="history-amount" *ngIf="!activity.amount">‚Äî</span>
          </div>
        </div>
        <div class="empty-message" *ngIf="itemHistory().length === 0">
          No history available
        </div>
      </div>
    </div>

    <!-- Error Message -->
    <div class="error-banner" *ngIf="error()">
      {{ error() }}
    </div>
  </div>

  <!-- Loading State -->
  <ng-template #loading>
    <div class="loading-state">
      <div class="loading-spinner"></div>
      <p>Loading item details...</p>
    </div>
  </ng-template>

  <!-- Price Change Modal -->
  <div class="modal-overlay" *ngIf="showPriceChangeModal()" (click)="closePriceChangeModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>Change Item Price</h2>
        <button type="button" class="close-btn" (click)="closePriceChangeModal()">√ó</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label for="newPrice">New Price</label>
          <input
            type="number"
            id="newPrice"
            [(ngModel)]="newPrice"
            class="form-control"
            step="0.01"
            min="0.01"
            placeholder="0.00">
        </div>
        <div class="form-group">
          <label for="priceReason">Reason (optional)</label>
          <textarea
            id="priceReason"
            [(ngModel)]="priceChangeReason"
            class="form-control"
            placeholder="e.g., End of season markdown"
            rows="3"></textarea>
        </div>
      </div>
      <div class="modal-actions">
        <button type="button" class="btn-secondary" (click)="closePriceChangeModal()">Cancel</button>
        <button
          type="button"
          class="btn-primary"
          (click)="updatePrice()"
          [disabled]="isUpdatingPrice() || newPrice <= 0"
        >
          {{ isUpdatingPrice() ? 'Updating...' : 'Update Price' }}
        </button>
      </div>
    </div>
  </div>
