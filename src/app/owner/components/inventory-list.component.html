<app-owner-layout>
      <div class="inventory-page">
        <!-- Header -->
        <div class="page-header">
          <div class="header-content">
            <h1>Inventory Management</h1>
            <p *ngIf="!isSquareInventoryMode()">View and manage all inventory items</p>
            <p *ngIf="isSquareInventoryMode()">Viewing inventory from Square</p>
          </div>
          <div class="header-actions">
            <button *ngIf="isSquareInventoryMode()" class="btn-secondary" (click)="refreshInventory()" [disabled]="isLoading()" title="Refresh Square inventory data">
              <span class="btn-icon">üîÑ</span>
              {{ isLoading() ? 'Refreshing Square Data...' : 'Refresh Square Data' }}
            </button>
            <button *ngIf="!isSquareInventoryMode()" class="btn-secondary" (click)="manageCategories()" title="Organize inventory with categories">
              <span class="btn-icon">üè∑Ô∏è</span>
              Manage Categories
            </button>
            <button *ngIf="!isSquareInventoryMode()" class="btn-secondary" (click)="openBulkImport()" title="Upload multiple items at once">
              <span class="btn-icon">üì§</span>
              Bulk Upload
            </button>
            <button *ngIf="!isSquareInventoryMode()" class="btn-primary" (click)="createNewItem()">
              <span class="btn-icon">üì¶</span>
              Add New Item
            </button>
          </div>
        </div>

        <!-- View Mode Toggle and Bulk Assign Combined -->
        <div class="view-mode-section" *ngIf="isSquareInventoryMode()">
          <div class="view-mode-toggle">
            <label class="radio-option">
              <input
                type="radio"
                name="viewMode"
                value="regular"
                [checked]="viewMode() === 'regular'"
                (change)="switchViewMode('regular')"
              />
              <span class="radio-label">
                <span class="radio-icon">üì¶</span>
                Regular Inventory
              </span>
            </label>
            <label class="radio-option">
              <input
                type="radio"
                name="viewMode"
                value="pending"
                [checked]="viewMode() === 'pending'"
                (change)="switchViewMode('pending')"
              />
              <span class="radio-label">
                <span class="radio-icon">üî≤</span>
                Pending Imports
              </span>
            </label>
          </div>

          <!-- Bulk Assign UI for Pending Imports (within same section) -->
          <div class="bulk-assign-subsection" *ngIf="viewMode() === 'pending'">
            <div class="bulk-assign-header">
              <h3 *ngIf="selectedPendingImports().size > 0">Bulk Assign {{ selectedPendingImports().size }} Selected Item(s)</h3>
              <h3 *ngIf="selectedPendingImports().size === 0">Select items to bulk assign to consignors</h3>
            </div>
            <div class="bulk-assign-controls">
              <div class="consignor-select-group">
                <label for="bulkConsignorSelect">Assign to Consignor:</label>
                <select
                  id="bulkConsignorSelect"
                  [(ngModel)]="selectedConsignorId"
                  class="consignor-select">
                  <option value="">Select a consignor...</option>
                  @for (consignor of consignors(); track consignor.id) {
                    <option [value]="consignor.id">{{ consignor.name }} ({{ consignor.consignorNumber }})</option>
                  }
                </select>
              </div>
              <div class="bulk-assign-actions">
                <button
                  class="btn-primary"
                  [disabled]="!selectedConsignorId() || selectedPendingImports().size === 0 || isLoading()"
                  (click)="bulkAssignConsignor()">
                  <span *ngIf="isLoading()" class="loading-spinner"></span>
                  {{ isLoading() ? 'Assigning...' : 'Assign Items' }}
                </button>
                <button
                  class="btn-secondary"
                  (click)="clearSelection()">
                  Cancel
                </button>
              </div>
            </div>
          </div>
        </div>


        <!-- Inventory Items Header -->
        <div class="inventory-header">
          <h2>Inventory Items</h2>
          <div class="header-controls">
            <!-- Search moved to header -->
            <input
              type="text"
              [(ngModel)]="searchQuery"
              (keyup.enter)="applyFilters()"
              placeholder="Search items..."
              class="header-search-input">

            <button class="legend-toggle" (click)="openColorGuideModal()" type="button">
              <span class="legend-icon">üé®</span>
              Color Guide
            </button>
            <select [(ngModel)]="pageSize" (change)="changePageSize()" class="page-size-select">
              <option value="10">10 per page</option>
              <option value="25">25 per page</option>
              <option value="50">50 per page</option>
              <option value="100">100 per page</option>
            </select>
          </div>
        </div>

        <!-- Results Section -->
        <div class="results-section">


          <div class="table-container" *ngIf="!isInventoryLoading() && pagedResult(); else loadingInventory">
            <table class="inventory-table compact-design" [class.pending-mode]="viewMode() === 'pending'">
              <thead>
                <tr>
                  <!-- Checkbox column for pending imports -->
                  <th class="checkbox-cell" *ngIf="viewMode() === 'pending'">
                    <input
                      type="checkbox"
                      [checked]="allPendingSelected()"
                      (change)="toggleSelectAll()"
                      title="Select All"
                    />
                  </th>
                  <th>Image</th>
                  <th (click)="setSorting('title')" class="sortable">
                    Title / SKU
                    <span class="sort-indicator" [class.active]="sortBy === 'title'">
                      {{ sortDirection === 'asc' ? '‚Üë' : '‚Üì' }}
                    </span>
                  </th>
                  <th colspan="2" style="text-align: center;">Category / Status</th>
                  <th (click)="setSorting('price')" class="sortable">
                    Price / Condition
                    <span class="sort-indicator" [class.active]="sortBy === 'price'">
                      {{ sortDirection === 'asc' ? '‚Üë' : '‚Üì' }}
                    </span>
                  </th>
                  <th>Consignor</th>
                  <th (click)="setSorting('receivedDate')" class="sortable">
                    Received / Expires
                    <span class="sort-indicator" [class.active]="sortBy === 'receivedDate'">
                      {{ sortDirection === 'asc' ? '‚Üë' : '‚Üì' }}
                    </span>
                  </th>
                  <th class="actions-cell">Actions</th>
                </tr>
                <!-- Filter row -->
                <tr class="filter-row">
                  <!-- Empty cell for checkbox column when in pending mode -->
                  <th *ngIf="viewMode() === 'pending'"></th>
                  <!-- Empty cell for image column -->
                  <th></th>
                  <!-- Empty cell for title/sku column -->
                  <th></th>
                  <!-- Category filter -->
                  <th class="category-filter">
                    <select [(ngModel)]="selectedCategory" (change)="applyFilters()" class="filter-select">
                      <option value="">All Categories</option>
                      @for (category of categories(); track category.id) {
                        <option [value]="category.name">{{ category.name }}</option>
                      }
                    </select>
                  </th>
                  <!-- Status filter -->
                  <th class="status-filter">
                    <select [(ngModel)]="selectedStatus" (change)="applyFilters()" class="filter-select">
                      <option value="">All Statuses</option>
                      <option value="Available">Available</option>
                      <option value="Sold">Sold</option>
                      <option value="Removed">Removed</option>
                    </select>
                  </th>
                  <!-- Condition filter -->
                  <th>
                    <select [(ngModel)]="selectedCondition" (change)="applyFilters()" class="filter-select">
                      <option value="">All Conditions</option>
                      <option value="New">New</option>
                      <option value="LikeNew">Like New</option>
                      <option value="Good">Good</option>
                      <option value="Fair">Fair</option>
                      <option value="Poor">Poor</option>
                    </select>
                  </th>
                  <!-- Consignor filter (new) -->
                  <th>
                    <select [(ngModel)]="selectedConsignor" (change)="applyFilters()" class="filter-select">
                      <option value="">All Consignors</option>
                      @for (consignor of consignors(); track consignor.id) {
                        <option [value]="consignor.id">{{ consignor.name }}</option>
                      }
                    </select>
                  </th>
                  <!-- Expiration filter -->
                  <th>
                    <select [(ngModel)]="selectedExpiration" (change)="applyFilters()" class="filter-select">
                      <option value="">All Items</option>
                      <option value="expiring-soon">‚ö†Ô∏è Expiring Soon (‚â§7 days)</option>
                      <option value="expired">üî¥ Expired</option>
                      <option value="this-month">This Month</option>
                      <option value="next-month">Next Month</option>
                    </select>
                  </th>
                  <!-- Empty Actions cell with hidden content -->
                  <th>
                    <span style="visibility: hidden;">&nbsp;</span>
                  </th>
                </tr>
              </thead>
              <tbody>
                <!-- Regular inventory items -->
                <ng-container *ngIf="viewMode() === 'regular' && itemsResult()">
                  <ng-container *ngFor="let item of itemsResult()!.items; let i = index">
                  <!-- Main item row -->
                  <tr class="item-row" [class.even]="i % 2 === 0">
                    <!-- Image -->
                    <td class="image-cell">
                      @if (item.primaryImageUrl) {
                        <img [src]="item.primaryImageUrl" [alt]="item.title" class="item-thumbnail">
                      } @else {
                        <div class="no-image">
                          üì∑
                        </div>
                      }
                    </td>

                    <!-- Title w/ SKU below -->
                    <td class="title-sku-cell">
                      <div class="item-title"
                           [title]="item.description || null">{{ item.title }}</div>
                      <div class="item-sku">{{ item.sku }}</div>
                    </td>

                    <!-- Category / Status -->
                    <td class="category-status-cell" colspan="2" style="text-align: center;">
                      <div class="category">{{ item.category }}</div>
                      <div class="status">
                        <span class="status-badge" [class]="'status-' + item.status.toLowerCase()">
                          {{ item.status }}
                        </span>
                      </div>
                    </td>

                    <!-- Price / Condition -->
                    <td class="price-condition-cell">
                      <div class="item-price">${{ item.price | number:'1.2-2' }}</div>
                      <div class="condition">
                        <span class="condition-badge" [class]="getConditionClass(item.condition)">
                          {{ getConditionLabel(item.condition) }}
                        </span>
                      </div>
                    </td>

                    <!-- Consignor -->
                    <td class="consignor-cell">
                      <div class="consignor-name"
                           [class.clickable]="item.consignorId"
                           (click)="viewConsignor(item.consignorId)"
                           [title]="item.consignorId ? 'Click to view consignor details' : ''">
                        {{ item.consignorName || 'Unassigned' }}
                      </div>
                    </td>

                    <!-- Received / Expires -->
                    <td class="dates-cell">
                      <div class="received-date">{{ item.receivedDate | date:'MMM d, y' }}</div>
                      <div class="expires-date" [class]="getExpirationStatusClass(item.expirationDate)">
                        {{ getExpirationDisplayText(item.expirationDate) }}
                      </div>
                    </td>

                    <!-- Actions -->
                    <td class="actions-cell">
                      <div class="action-buttons">
                        <button class="btn-icon" (click)="viewItem(item.itemId)" title="View Details">
                          üëÅÔ∏è
                        </button>
                        <button class="btn-icon" (click)="editItem(item.itemId)" title="Edit">
                          ‚úèÔ∏è
                        </button>
                        @if (item.status === 'Available') {
                          <button class="btn-icon" (click)="markAsRemoved(item)" title="Mark as Removed">
                            üì¶
                          </button>
                        }
                        <button class="btn-icon danger" (click)="deleteItem(item)" title="Delete">
                          üóëÔ∏è
                        </button>
                      </div>
                    </td>
                  </tr>
                  </ng-container>
                </ng-container>

                <!-- Pending imports -->
                <ng-container *ngIf="viewMode() === 'pending' && pendingImportsResult()">
                  <ng-container *ngFor="let pendingItem of pendingImportsResult()!.items; let i = index">
                    <!-- Main pending import row -->
                    <tr class="item-row pending-import-row" [class.even]="i % 2 === 0">
                      <!-- Checkbox -->
                      <td class="checkbox-cell">
                        <input
                          type="checkbox"
                          [checked]="isSelected(pendingItem.pendingImportId)"
                          (change)="toggleSelectItem(pendingItem.pendingImportId)"
                          title="Select Item"
                        />
                      </td>
                      <!-- Image -->
                      <td class="image-cell">
                        <div class="no-image pending-icon">
                          üî≤
                        </div>
                      </td>

                      <!-- Title w/ SKU below -->
                      <td class="title-sku-cell">
                        <div class="item-title" [title]="pendingItem.description || null">{{ pendingItem.name }}</div>
                        <div class="item-sku">{{ pendingItem.sku || '‚Äî' }}</div>
                      </td>

                      <!-- Category / Status -->
                      <td class="category-status-cell" colspan="2" style="text-align: center;">
                        <div class="category">{{ pendingItem.category || '‚Äî' }}</div>
                        <div class="status">
                          <span class="status-badge status-pending">PENDING_ASSIGNMENT</span>
                        </div>
                      </td>

                      <!-- Price / Condition -->
                      <td class="price-condition-cell">
                        <div class="item-price">${{ pendingItem.price | number:'1.2-2' }}</div>
                        <div class="condition">
                          <span class="condition-badge condition-new">Imported</span>
                        </div>
                      </td>

                      <!-- Consignor -->
                      <td class="consignor-cell">
                        <div class="consignor-name unassigned">
                          Needs Assignment
                        </div>
                      </td>

                      <!-- Received / Expires -->
                      <td class="dates-cell">
                        <div class="received-date">{{ pendingItem.importedAt | date:'MMM d, y' }}</div>
                        <div class="expires-date">‚Äî</div>
                      </td>

                      <!-- Actions -->
                      <td class="actions-cell">
                        <div class="action-buttons">
                          <div class="individual-assign-wrapper">
                            @if (assignmentDropdownOpen() === pendingItem.pendingImportId) {
                              <div class="assignment-dropdown">
                                <select
                                  [value]="getIndividualConsignorSelection(pendingItem.pendingImportId)"
                                  (change)="onConsignorSelectionChange(pendingItem.pendingImportId, $event)"
                                  class="consignor-select-small">
                                  <option value="">Select consignor...</option>
                                  @for (consignor of consignors(); track consignor.id) {
                                    <option [value]="consignor.id">{{ consignor.name }} ({{ consignor.consignorNumber }})</option>
                                  }
                                </select>
                                <div class="assignment-actions">
                                  <button
                                    class="btn-primary-small"
                                    [disabled]="!getIndividualConsignorSelection(pendingItem.pendingImportId) || isLoading()"
                                    (click)="confirmIndividualAssignment(pendingItem.pendingImportId)">
                                    ‚úì
                                  </button>
                                  <button
                                    class="btn-secondary-small"
                                    (click)="cancelIndividualAssignment(pendingItem.pendingImportId)">
                                    ‚úï
                                  </button>
                                </div>
                              </div>
                            } @else {
                              <button
                                class="btn-primary-small"
                                title="Assign to Consignor"
                                [disabled]="selectedPendingImports().size > 1"
                                (click)="toggleAssignmentDropdown(pendingItem.pendingImportId)">
                                Assign
                              </button>
                            }
                          </div>
                        </div>
                      </td>
                    </tr>
                  </ng-container>
                </ng-container>
              </tbody>
            </table>

            <!-- Pagination -->
            <div class="pagination" *ngIf="pagedResult()!.totalPages > 1">
              <button
                class="page-btn"
                [disabled]="currentPage() === 1"
                (click)="goToPage(currentPage() - 1)">
                Previous
              </button>

              <div class="page-numbers">
                <button
                  *ngFor="let page of visiblePages()"
                  class="page-btn"
                  [class.active]="page === currentPage()"
                  (click)="goToPage(page)">
                  {{ page }}
                </button>
              </div>

              <button
                class="page-btn"
                [disabled]="currentPage() === pagedResult()!.totalPages"
                (click)="goToPage(currentPage() + 1)">
                Next
              </button>
            </div>
          </div>

          <ng-template #loadingInventory>
            <div class="loading-state" *ngIf="isInventoryLoading()">
              <div class="loading-spinner"></div>
              <p>Loading inventory...</p>
            </div>
            <div class="empty-state" *ngIf="!isInventoryLoading() && (!pagedResult() || pagedResult()!.items.length === 0)">
              <p>No inventory items found.</p>
              <button class="btn-primary" (click)="createNewItem()">
                <span class="btn-icon">üì¶</span>
                Add Your First Item
              </button>
            </div>
          </ng-template>
        </div>

      </div>
    </app-owner-layout>

    <!-- Bulk Import Modal -->
    <app-bulk-import-modal
      [isOpen]="isBulkImportModalOpen()"
      [preloadedItems]="preloadedItems()"
      (closeModal)="closeBulkImportModal()"
      (itemsImported)="onItemsImported($event)">
    </app-bulk-import-modal>

    <!-- Color Guide Modal -->
    <div class="modal-overlay" *ngIf="isColorGuideModalOpen()" (click)="closeColorGuideModal()">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3 class="modal-title">Color Guide</h3>
          <button class="modal-close-btn" (click)="closeColorGuideModal()">√ó</button>
        </div>

        <div class="modal-legend-section">
          <h4>Item Condition</h4>
          <div class="modal-legend-items">
            <div class="modal-legend-item">
              <span class="condition-badge condition-new">NEW</span>
              <span class="modal-legend-text">Perfect/Unused</span>
            </div>
            <div class="modal-legend-item">
              <span class="condition-badge condition-like-new">LIKE NEW</span>
              <span class="modal-legend-text">Excellent</span>
            </div>
            <div class="modal-legend-item">
              <span class="condition-badge condition-good">GOOD</span>
              <span class="modal-legend-text">Good quality</span>
            </div>
            <div class="modal-legend-item">
              <span class="condition-badge condition-fair">FAIR</span>
              <span class="modal-legend-text">Some wear</span>
            </div>
            <div class="modal-legend-item">
              <span class="condition-badge condition-poor">POOR</span>
              <span class="modal-legend-text">Heavy wear</span>
            </div>
          </div>
        </div>

        <div class="modal-legend-section">
          <h4>Item Status</h4>
          <div class="modal-legend-items">
            <div class="modal-legend-item">
              <span class="status-badge status-available">AVAILABLE</span>
              <span class="modal-legend-text">Ready for sale</span>
            </div>
            <div class="modal-legend-item">
              <span class="status-badge status-sold">SOLD</span>
              <span class="modal-legend-text">Successfully sold</span>
            </div>
            <div class="modal-legend-item">
              <span class="status-badge status-removed">REMOVED</span>
              <span class="modal-legend-text">No longer available</span>
            </div>
          </div>
        </div>
      </div>
    </div>