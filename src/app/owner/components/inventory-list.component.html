<app-owner-layout>
  <div class="inventory-page">
    <!-- Header -->
    <div class="page-header">
      <div class="header-content">
        <h1>Inventory Management</h1>
        <p *ngIf="!isSquareInventoryMode()">View and manage all inventory items</p>
        <p *ngIf="isSquareInventoryMode()">Viewing inventory from Square</p>
      </div>
      <div class="header-actions">
        <button *ngIf="isSquareInventoryMode()" class="btn-secondary" (click)="refreshInventory()" [disabled]="isLoading()" title="Refresh Square inventory data">
          <span class="btn-icon">üîÑ</span>
          {{ isLoading() ? 'Refreshing Square Data...' : 'Refresh Square Data' }}
        </button>
        <button *ngIf="!isSquareInventoryMode()" class="btn-secondary" (click)="manageCategories()" title="Organize inventory with categories">
          <span class="btn-icon">üè∑Ô∏è</span>
          Manage Categories
        </button>
        <button *ngIf="!isSquareInventoryMode()" class="btn-secondary" (click)="openBulkImport()" title="Upload multiple items at once">
          <span class="btn-icon">üì§</span>
          Bulk Upload
        </button>
        <button *ngIf="!isSquareInventoryMode()" class="btn-primary" (click)="createNewItem()">
          <span class="btn-icon">üì¶</span>
          Add New Item
        </button>
      </div>
    </div>

    <!-- Tab Navigation -->
    <div class="tab-navigation">
      <div class="tab-list">
        <button
          class="tab-button"
          [class.active]="viewMode() === 'regular'"
          (click)="switchViewMode('regular')">
          <span class="tab-icon">üì¶</span>
          Regular Inventory
          <span class="tab-count" *ngIf="itemsResult()?.totalCount">({{ itemsResult()!.totalCount }})</span>
        </button>
        <button
          class="tab-button"
          [class.active]="viewMode() === 'pending'"
          (click)="switchViewMode('pending')"
          *ngIf="isSquareInventoryMode()">
          <span class="tab-icon">‚è≥</span>
          Pending Imports
          <span class="tab-count" *ngIf="pendingImportsResult()?.totalCount">({{ pendingImportsResult()!.totalCount }})</span>
        </button>
      </div>
      <div class="tab-actions">
        <button class="btn-secondary" (click)="openBulkImport()" title="Import items from CSV file">
          <span class="btn-icon">üì§</span>
          Bulk Import
        </button>
      </div>
    </div>

    <!-- Regular Inventory Tab -->
    <div class="tab-panel" [class.active]="viewMode() === 'regular'" *ngIf="viewMode() === 'regular'">
      <!-- Search and Controls -->
      <div class="tab-controls">
        <div class="search-section">
          <input
            type="text"
            [(ngModel)]="searchQuery"
            (keyup.enter)="applyFilters()"
            placeholder="Search items..."
            class="search-input">
          <button class="btn-secondary" (click)="applyFilters()">Search</button>
        </div>
        <div class="controls-section">
          <button class="btn-secondary" (click)="openColorGuideModal()" type="button">
            <span class="btn-icon">üé®</span>
            Color Guide
          </button>
          <select [(ngModel)]="pageSize" (change)="changePageSize()" class="page-size-select">
            <option value="10">10 per page</option>
            <option value="25">25 per page</option>
            <option value="50">50 per page</option>
            <option value="100">100 per page</option>
          </select>
        </div>
      </div>

      <!-- Filters -->
      <div class="filters-section">
        <select [(ngModel)]="selectedCategory" (change)="applyFilters()" class="filter-select">
          <option value="">All Categories</option>
          @for (category of categories(); track category.id) {
            <option [value]="category.name">{{ category.name }}</option>
          }
        </select>
        <select [(ngModel)]="selectedStatus" (change)="applyFilters()" class="filter-select">
          <option value="">All Statuses</option>
          <option value="Available">Available</option>
          <option value="Sold">Sold</option>
          <option value="Removed">Removed</option>
        </select>
        <select [(ngModel)]="selectedCondition" (change)="applyFilters()" class="filter-select">
          <option value="">All Conditions</option>
          <option value="New">New</option>
          <option value="LikeNew">Like New</option>
          <option value="Good">Good</option>
          <option value="Fair">Fair</option>
          <option value="Poor">Poor</option>
        </select>
        <select [(ngModel)]="selectedConsignor" (change)="applyFilters()" class="filter-select">
          <option value="">All Consignors</option>
          @for (consignor of consignors(); track consignor.id) {
            <option [value]="consignor.id">{{ consignor.name }}</option>
          }
        </select>
        <select [(ngModel)]="selectedExpiration" (change)="applyFilters()" class="filter-select">
          <option value="">All Items</option>
          <option value="expiring-soon">‚ö†Ô∏è Expiring Soon (‚â§7 days)</option>
          <option value="expired">üî¥ Expired</option>
          <option value="this-month">This Month</option>
          <option value="next-month">Next Month</option>
        </select>
      </div>

      <!-- Regular Inventory Table -->
      <div class="table-container" *ngIf="!isInventoryLoading() && itemsResult(); else loadingInventory">
        <div class="table-wrapper">
          <table class="inventory-table">
            <thead>
              <tr>
                <th>Image</th>
                <th (click)="setSorting('title')" class="sortable">
                  Title / SKU
                  <span class="sort-indicator" [class.active]="sortBy === 'title'">
                    {{ sortDirection === 'asc' ? '‚Üë' : '‚Üì' }}
                  </span>
                </th>
                <th>Category</th>
                <th>Status</th>
                <th (click)="setSorting('price')" class="sortable">
                  Price
                  <span class="sort-indicator" [class.active]="sortBy === 'price'">
                    {{ sortDirection === 'asc' ? '‚Üë' : '‚Üì' }}
                  </span>
                </th>
                <th>Condition</th>
                <th>Consignor</th>
                <th (click)="setSorting('receivedDate')" class="sortable">
                  Received
                  <span class="sort-indicator" [class.active]="sortBy === 'receivedDate'">
                    {{ sortDirection === 'asc' ? '‚Üë' : '‚Üì' }}
                  </span>
                </th>
                <th>Expires</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              @for (item of itemsResult()?.items; track item.id; let i = $index) {
                <tr class="item-row" [class.even]="i % 2 === 0">
                  <td class="image-cell">
                    @if (item.primaryImageUrl) {
                      <img [src]="item.primaryImageUrl" [alt]="item.title" class="item-thumbnail">
                    } @else {
                      <div class="no-image">üì∑</div>
                    }
                  </td>
                  <td class="title-cell">
                    <div class="item-title" [title]="item.description || null">{{ item.title }}</div>
                    <div class="item-sku">{{ item.sku }}</div>
                  </td>
                  <td class="category-cell">{{ item.category }}</td>
                  <td class="status-cell">
                    <span class="status-badge" [class]="'status-' + item.status.toLowerCase()">
                      {{ item.status }}
                    </span>
                  </td>
                  <td class="price-cell">${{ item.price | number:'1.2-2' }}</td>
                  <td class="condition-cell">
                    <span class="condition-badge" [class]="getConditionClass(item.condition)">
                      {{ getConditionLabel(item.condition) }}
                    </span>
                  </td>
                  <td class="consignor-cell">
                    <div class="consignor-name"
                         [class.clickable]="item.consignorId"
                         (click)="viewConsignor(item.consignorId)"
                         [title]="item.consignorId ? 'Click to view consignor details' : ''">
                      {{ item.consignorName || 'Unassigned' }}
                    </div>
                  </td>
                  <td class="received-cell">{{ item.receivedDate | date:'MMM d, y' }}</td>
                  <td class="expires-cell" [class]="getExpirationStatusClass(item.expirationDate)">
                    {{ getExpirationDisplayText(item.expirationDate) }}
                  </td>
                  <td class="actions-cell">
                    <div class="action-buttons">
                      <button class="btn-secondary-small" (click)="editItem(item.id)" title="Edit Item">
                        <span class="btn-icon">‚úèÔ∏è</span>
                      </button>
                      <button class="btn-secondary-small" (click)="markAsSold(item.id)" title="Mark as Sold" *ngIf="item.status === 'Available'">
                        <span class="btn-icon">üí∞</span>
                      </button>
                    </div>
                  </td>
                </tr>
              }
            </tbody>
          </table>
        </div>

        <!-- Pagination for Regular Inventory -->
        <div class="pagination" *ngIf="itemsResult() && itemsResult()!.totalPages > 1">
          <button class="page-btn" [disabled]="currentPage() === 1" (click)="goToPage(currentPage() - 1)">
            Previous
          </button>
          @for (page of getPageNumbers(); track page) {
            <button
              class="page-btn"
              [class.active]="page === currentPage()"
              (click)="goToPage(page)">
              {{ page }}
            </button>
          }
          <button class="page-btn" [disabled]="currentPage() === itemsResult()?.totalPages" (click)="goToPage(currentPage() + 1)">
            Next
          </button>
        </div>
      </div>
    </div>

    <!-- Pending Imports Tab -->
    <div class="tab-panel" [class.active]="viewMode() === 'pending'" *ngIf="viewMode() === 'pending'">

      <!-- Bulk Actions Section -->
      <div class="bulk-actions-section">
        <div class="bulk-actions-header">
          <h3>Bulk Operations</h3>
          <div class="selected-count" *ngIf="selectedPendingImports().size > 0">
            {{ selectedPendingImports().size }} item(s) selected for assignment
          </div>
        </div>
        <div class="bulk-actions-controls">
          <div class="consignor-assignment">
            <label for="bulkConsignorSelect">Assign to Consignor:</label>
            <select id="bulkConsignorSelect" [(ngModel)]="selectedConsignorId" class="consignor-select">
              <option value="">Select a consignor...</option>
              @for (consignor of consignors(); track consignor.id) {
                <option [value]="consignor.id">{{ consignor.name }} ({{ consignor.consignorNumber }})</option>
              }
            </select>
            <button
              class="btn-secondary"
              [disabled]="!selectedConsignorId() || selectedPendingImports().size === 0 || isLoading()"
              (click)="bulkAssignConsignor()">
              <span *ngIf="isLoading()" class="loading-spinner"></span>
              {{ isLoading() ? 'Assigning...' : 'Assign Selected' }}
            </button>
          </div>
          <div class="verification-actions">
            <button
              class="btn-primary"
              [disabled]="verifiedPendingImports().size === 0 || isLoading()"
              (click)="submitVerifiedItems()">
              <span *ngIf="isLoading()" class="loading-spinner"></span>
              {{ isLoading() ? 'Importing...' : 'Import Verified Items (' + verifiedPendingImports().size + ')' }}
            </button>
          </div>
        </div>
      </div>

      <!-- Search and Controls -->
      <div class="tab-controls">
        <div class="search-section">
          <input
            type="text"
            [(ngModel)]="searchQuery"
            (keyup.enter)="applyFilters()"
            placeholder="Search pending imports..."
            class="search-input">
          <button class="btn-secondary" (click)="applyFilters()">Search</button>
        </div>
        <div class="controls-section">
          <select [(ngModel)]="pageSize" (change)="changePageSize()" class="page-size-select">
            <option value="10">10 per page</option>
            <option value="25">25 per page</option>
            <option value="50">50 per page</option>
            <option value="100">100 per page</option>
          </select>
        </div>
      </div>

      <!-- Pending Imports Table -->
      <div class="table-container" *ngIf="!isInventoryLoading() && pendingImportsResult(); else loadingPending">
        <div class="table-wrapper">
          <table class="inventory-table pending-table">
            <thead>
              <tr>
                <th class="checkbox-cell">
                  <div class="checkbox-header">
                    <label class="checkbox-label">
                      <input
                        type="checkbox"
                        [checked]="allPendingVerified()"
                        (change)="toggleAllVerification($event)"
                        class="checkbox-input">
                      <span class="checkbox-custom"></span>
                      <span class="checkbox-text">Verified</span>
                    </label>
                  </div>
                </th>
                <th class="checkbox-cell">
                  <div class="checkbox-header">
                    <label class="checkbox-label">
                      <input
                        type="checkbox"
                        [checked]="allPendingSelected()"
                        (change)="toggleSelectAll()"
                        class="checkbox-input">
                      <span class="checkbox-custom"></span>
                      <span class="checkbox-text">Assign</span>
                    </label>
                  </div>
                </th>
                <th>Item</th>
                <th>Price</th>
                <th>SKU</th>
                <th>Category</th>
                <th>Condition</th>
                <th>Assigned Consignor</th>
                <th>Source</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              @for (item of pendingImportsResult()?.items; track item.id; let i = $index) {
                <tr class="pending-item-row" [class.even]="i % 2 === 0">
                  <td class="checkbox-cell">
                    <label class="checkbox-label">
                      <input
                        type="checkbox"
                        [checked]="verifiedPendingImports().has(item.id)"
                        (change)="toggleItemVerification(item.id, $event)"
                        class="checkbox-input">
                      <span class="checkbox-custom"></span>
                    </label>
                  </td>
                  <td class="checkbox-cell">
                    <label class="checkbox-label">
                      <input
                        type="checkbox"
                        [checked]="selectedPendingImports().has(item.id)"
                        [disabled]="!!getAssignedConsignorName(item.id)"
                        (change)="toggleSelectItem(item.id)"
                        class="checkbox-input">
                      <span class="checkbox-custom"></span>
                    </label>
                  </td>
                  <td class="item-cell">
                    <div class="item-info">
                      <div class="item-name" [title]="item.description || null">{{ item.name }}</div>
                      <div class="item-description" *ngIf="item.description">{{ item.description }}</div>
                    </div>
                  </td>
                  <td class="price-cell">${{ item.price | number:'1.2-2' }}</td>
                  <td class="sku-cell">{{ item.sku || '‚Äî' }}</td>
                  <td class="category-cell">{{ item.category || '‚Äî' }}</td>
                  <td class="condition-cell">
                    <span class="condition-badge condition-new">{{ item.condition || 'Imported' }}</span>
                  </td>
                  <td class="consignor-cell">
                    <div class="consignor-assignment"
                         [class.assigned]="item.consignorName"
                         [class.unassigned]="!item.consignorName">
                      @if (item.consignorName; as consignorName) {
                        <span class="assigned-consignor">{{ consignorName }} ({{ item.consignorNumber || 'N/A' }})</span>
                      } @else {
                        <span class="needs-assignment">Needs Assignment</span>
                      }
                    </div>
                  </td>
                  <td class="source-cell">
                    <span class="source-badge" [class]="'source-' + item.source?.toLowerCase()">
                      {{ item.source || 'Unknown' }}
                    </span>
                  </td>
                  <td class="actions-cell">
                    <div class="action-buttons">
                      @if (assignmentDropdownOpen() === item.id) {
                        <div class="assignment-dropdown">
                          <select
                            [value]="getIndividualConsignorSelection(item.id)"
                            (change)="onConsignorSelectionChange(item.id, $event)"
                            class="consignor-select-small">
                            <option value="">Select consignor...</option>
                            @for (consignor of consignors(); track consignor.id) {
                              <option [value]="consignor.id">{{ consignor.name }} ({{ consignor.consignorNumber }})</option>
                            }
                          </select>
                          <div class="assignment-actions">
                            <button
                              class="btn-primary-small"
                              [disabled]="!getIndividualConsignorSelection(item.id) || isLoading()"
                              (click)="confirmIndividualAssignment(item.id)"
                              title="Confirm Assignment">
                              ‚úì
                            </button>
                            <button
                              class="btn-secondary-small"
                              (click)="cancelIndividualAssignment(item.id)"
                              title="Cancel Assignment">
                              ‚úï
                            </button>
                          </div>
                        </div>
                      } @else {
                        <button
                          class="btn-icon"
                          [title]="getAssignedConsignorName(item.id) ? 'Change assigned consignor' : 'Assign to Consignor'"
                          [disabled]="selectedPendingImports().size > 1"
                          (click)="toggleAssignmentDropdown(item.id)">
                          üë§
                        </button>
                        <button
                          class="btn-icon btn-danger"
                          title="Delete Item"
                          (click)="deletePendingItem(item.id)">
                          üóëÔ∏è
                        </button>
                      }
                    </div>
                  </td>
                </tr>
              }
            </tbody>
          </table>
        </div>

        <!-- Pagination for Pending Imports -->
        <div class="pagination" *ngIf="pendingImportsResult() && pendingImportsResult()!.totalPages > 1">
          <button class="page-btn" [disabled]="currentPage() === 1" (click)="goToPage(currentPage() - 1)">
            Previous
          </button>
          @for (page of getPageNumbers(); track page) {
            <button
              class="page-btn"
              [class.active]="page === currentPage()"
              (click)="goToPage(page)">
              {{ page }}
            </button>
          }
          <button class="page-btn" [disabled]="currentPage() === pendingImportsResult()?.totalPages" (click)="goToPage(currentPage() + 1)">
            Next
          </button>
        </div>
      </div>
    </div>

    <!-- Loading States -->
    <ng-template #loadingInventory>
      <div class="loading-state">
        <div class="loading-spinner"></div>
        <p>Loading inventory...</p>
      </div>
    </ng-template>

    <ng-template #loadingPending>
      <div class="loading-state">
        <div class="loading-spinner"></div>
        <p>Loading pending imports...</p>
      </div>
    </ng-template>

    <!-- Empty States -->
    <div class="empty-state" *ngIf="!isInventoryLoading() && viewMode() === 'regular' && itemsResult()?.items.length === 0">
      <div class="empty-icon">üì¶</div>
      <h3>No inventory items found</h3>
      <p>Try adjusting your search or filters, or add new items to your inventory.</p>
    </div>

    <div class="empty-state" *ngIf="!isInventoryLoading() && viewMode() === 'pending' && pendingImportsResult()?.items.length === 0">
      <div class="empty-icon">‚è≥</div>
      <h3>No pending imports found</h3>
      <p>Import items from Square or upload via manifest to see them here.</p>
    </div>

    <!-- Error State -->
    <div class="error-state" *ngIf="error()">
      <div class="error-icon">‚ö†Ô∏è</div>
      <h3>Something went wrong</h3>
      <p>{{ error() }}</p>
      <button class="btn-primary" (click)="loadItems()">Try Again</button>
    </div>

    <!-- Color Guide Modal (preserved from original) -->
    <div class="color-guide-modal" *ngIf="isColorGuideModalOpen()">
      <div class="modal-backdrop" (click)="closeColorGuideModal()"></div>
      <div class="modal-content">
        <div class="modal-header">
          <h3>Status & Condition Color Guide</h3>
          <button class="modal-close" (click)="closeColorGuideModal()">&times;</button>
        </div>
        <div class="modal-body">
          <div class="guide-section">
            <h4>Status Colors</h4>
            <div class="color-examples">
              <div class="color-example">
                <span class="status-badge status-available">Available</span>
                <span>Available for sale</span>
              </div>
              <div class="color-example">
                <span class="status-badge status-sold">Sold</span>
                <span>Successfully sold</span>
              </div>
              <div class="color-example">
                <span class="status-badge status-removed">Removed</span>
                <span>Removed from inventory</span>
              </div>
            </div>
          </div>
          <div class="guide-section">
            <h4>Condition Colors</h4>
            <div class="color-examples">
              <div class="color-example">
                <span class="condition-badge condition-new">New</span>
                <span>Brand new, tags attached</span>
              </div>
              <div class="color-example">
                <span class="condition-badge condition-like-new">Like New</span>
                <span>Excellent condition, barely used</span>
              </div>
              <div class="color-example">
                <span class="condition-badge condition-good">Good</span>
                <span>Normal wear, good condition</span>
              </div>
              <div class="color-example">
                <span class="condition-badge condition-fair">Fair</span>
                <span>Visible wear, still functional</span>
              </div>
              <div class="color-example">
                <span class="condition-badge condition-poor">Poor</span>
                <span>Significant wear, priced accordingly</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Bulk Import Modal -->
    <div class="modal-overlay" *ngIf="isBulkImportModalOpen()" (click)="closeBulkImport()">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h2 class="modal-title">üì¶ Bulk Import Items</h2>
          <button class="close-button" (click)="closeBulkImport()" type="button">√ó</button>
        </div>
        <div class="modal-body">
          <div class="upload-section">
            <div class="upload-icon">üìÑ</div>
            <div class="upload-title">Import Items from CSV</div>
            <div class="upload-description">
              Upload a CSV file to import multiple items at once.<br>
              Items will be created as pending imports that you can review and assign to consignors.
            </div>
            <div class="upload-buttons">
              <input type="file" #fileInput accept=".csv" style="display: none;" (change)="onFileSelected($event)" />
              <button class="btn-primary" (click)="fileInput.click()">
                Choose CSV File
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>
</app-owner-layout>