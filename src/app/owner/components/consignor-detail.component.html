<app-owner-layout>
  <div class="detail-page" *ngIf="!isProviderLoading(); else loading">
    
    <!-- Page Header -->
    <div class="page-header">
      <div class="header-content">
        <button class="btn-secondary" routerLink="/owner/consignors">
          ‚Üê Back to Consignors
        </button>
      </div>
      <div class="header-actions">
        <div class="dropdown">
          <button class="btn-primary dropdown-toggle" type="button">
            Actions ‚ñº
          </button>
          <div class="dropdown-menu">
            <a class="dropdown-item" [routerLink]="['/owner/consignors', providerId(), 'edit']">
              ‚úèÔ∏è Edit Consignor
            </a>
            <div class="dropdown-divider"></div>
            <button
              class="dropdown-item"
              *ngIf="consignor()?.status === 'active'"
              (click)="deactivateProvider()"
              [disabled]="isSubmitting()"
            >
              {{ isSubmitting() ? 'Deactivating...' : '‚è∏Ô∏è Deactivate' }}
            </button>
            <button
              class="dropdown-item"
              *ngIf="consignor()?.status !== 'active'"
              (click)="activateProvider()"
              [disabled]="isSubmitting()"
            >
              {{ isSubmitting() ? 'Activating...' : '‚ñ∂Ô∏è Activate' }}
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Entity Title Row -->
    <div class="entity-header" *ngIf="consignor()">
      <h1>{{ consignor()!.name }}</h1>
      <div class="entity-meta">
        <span class="badge" [ngClass]="{
          'badge-success': consignor()!.status === 'active',
          'badge-error': consignor()!.status !== 'active'
        }">
          {{ consignor()!.status === 'active' ? 'Active' : 'Inactive' }}
        </span>
        <span class="meta-id">Consignor #{{ consignor()!.consignorNumber }}</span>
      </div>
    </div>

    <!-- Main Content Card -->
    <div class="detail-card" *ngIf="consignor()">
      
      <!-- Stats Bar -->
      <div class="stats-bar">
        <div class="stat-item">
          <span class="stat-value">{{ stats().totalItems || 0 }}</span>
          <span class="stat-label">Total Items</span>
        </div>
        <div class="stat-item">
          <span class="stat-value">{{ stats().activeItems || 0 }}</span>
          <span class="stat-label">Active Items</span>
        </div>
        <div class="stat-item">
          <span class="stat-value">{{ stats().soldItems || 0 }}</span>
          <span class="stat-label">Sold Items</span>
        </div>
        <div class="stat-item">
          <span class="stat-value">{{ stats().totalEarnings | currency:'USD':'symbol':'1.2-2' }}</span>
          <span class="stat-label">Total Earnings</span>
        </div>
        <div class="stat-item">
          <span class="stat-value">{{ stats().pendingPayout | currency:'USD':'symbol':'1.2-2' }}</span>
          <span class="stat-label">Pending Payout</span>
        </div>
      </div>

      <!-- Info Sections -->
      <div class="info-container">
        <div class="info-row">
          <!-- Contact Information -->
          <div class="info-section">
            <div class="section-header">
              <h3>Contact Information</h3>
              <button
                class="btn-secondary btn-sm"
                (click)="textContactInfo()"
                [disabled]="isSendingContactInfo()"
                title="Send contact info to owner notifications"
              >
                {{ isSendingContactInfo() ? 'Sending...' : 'üì± Text Contact Info' }}
              </button>
            </div>
            <div class="info-grid">
              <div class="info-item">
                <span class="info-label">Email</span>
                <span class="info-value">{{ consignor()!.email }}</span>
              </div>
              <div class="info-item" *ngIf="consignorDetails()?.phone">
                <span class="info-label">Phone</span>
                <span class="info-value">{{ formatPhoneNumber(consignorDetails()!.phone) }}</span>
              </div>
              <div class="info-item">
                <span class="info-label">Mailing Address</span>
                <ng-container *ngIf="consignorDetails()?.addressLine1">
                  <span class="info-value">
                    {{ consignorDetails()!.addressLine1 }}<br>
                    <ng-container *ngIf="consignorDetails()!.addressLine2">{{ consignorDetails()!.addressLine2 }}<br></ng-container>
                    <ng-container *ngIf="consignorDetails()!.city">{{ consignorDetails()!.city }}</ng-container><ng-container *ngIf="consignorDetails()!.city && consignorDetails()!.state">, </ng-container>{{ consignorDetails()!.state }} {{ consignorDetails()!.postalCode }}
                  </span>
                </ng-container>
                <span class="info-value" *ngIf="!consignorDetails()?.addressLine1 && consignor()?.address">
                  {{ consignor()!.address }}
                </span>
                <span class="info-value text-muted" *ngIf="!consignorDetails()?.addressLine1 && !consignor()?.address">
                  No address on file
                </span>
              </div>
            </div>
          </div>

          <!-- Business Information -->
          <div class="info-section">
            <h3>Business Information</h3>
            <div class="info-grid">
              <div class="info-item">
                <span class="info-label">Commission Rate</span>
                <span class="info-value">{{ consignor()!.commissionRate }}%</span>
              </div>
              <div class="info-item" *ngIf="consignor()!.preferredPaymentMethod">
                <span class="info-label">Preferred Payment</span>
                <span class="info-value">{{ consignor()!.preferredPaymentMethod }}</span>
              </div>
              <div class="info-item" *ngIf="consignor()!.paymentDetails">
                <span class="info-label">Payment Details</span>
                <span class="info-value">{{ consignor()!.paymentDetails }}</span>
              </div>
              <div class="info-item">
                <span class="info-label">Consignor Number</span>
                <span class="info-value cell-mono">{{ consignor()!.consignorNumber }}</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Notes Section -->
        <div class="info-section full-width" *ngIf="consignor()!.notes">
          <h3>Notes</h3>
          <div class="notes-display">{{ consignor()!.notes }}</div>
        </div>

        <!-- Agreement Section -->
        <div class="info-section full-width" *ngIf="showAgreementSection()">
          <h3>Agreement</h3>
          <div class="agreement-box" [ngClass]="{
            'agreement-pending': agreementStatus()?.status === 'pending',
            'agreement-complete': agreementStatus()?.status === 'on_file' || agreementStatus()?.status === 'uploaded' || isConsignorCompleted()
          }">
            
            <!-- Pending State -->
            <ng-container *ngIf="agreementStatus()?.status === 'pending'">
              <div class="agreement-status">
                <span class="badge badge-warn">Pending</span>
                <span>Consignor has not completed the agreement requirement</span>
              </div>
              <div class="agreement-actions">
                <button class="btn-secondary" (click)="openMarkOnFileModal()">
                  Mark Agreement on File
                </button>
                <button class="btn-secondary" (click)="openUploadModal()">
                  Upload Signed Copy
                </button>
              </div>
            </ng-container>

            <!-- Completed State -->
            <ng-container *ngIf="agreementStatus()?.status === 'on_file' || agreementStatus()?.status === 'uploaded' || isConsignorCompleted()">
              <div class="agreement-status">
                <span class="badge badge-success">Completed</span>
                <span *ngIf="agreementStatus()?.receivedAt">Uploaded {{ agreementStatus()?.receivedAt | date:'MMM d, y' }}</span>
              </div>
              <div class="agreement-note" *ngIf="agreementNotes()">
                Note: "{{ agreementNotes() }}"
              </div>
              <div class="agreement-actions">
                <button class="btn-secondary" *ngIf="agreementStatus()?.method === 'consignor_acknowledge'" (click)="viewAcknowledgedTerms()">
                  View Terms Acknowledged
                </button>
                <button class="btn-secondary" *ngIf="agreementStatus()?.status === 'uploaded' || agreementStatus()?.method === 'consignor_upload'" (click)="viewDocument()">
                  View Document
                </button>
                <button class="btn-secondary" (click)="openUploadModal()">
                  Upload Signed Agreement
                </button>
                <button class="btn-danger" *ngIf="agreementStatus()?.status === 'on_file' || agreementStatus()?.status === 'uploaded'" (click)="confirmRemoveAgreement()">
                  Remove
                </button>
              </div>
            </ng-container>
          </div>
        </div>
      </div>

      <!-- Recent Activity -->
      <div class="activity-section">
        <h3>Recent Activity</h3>
        <div class="activity-table" *ngIf="recentActivity().length > 0">
          <div class="activity-row" *ngFor="let activity of recentActivity()">
            <span class="activity-icon">{{ getActivityIcon(activity.type) }}</span>
            <span class="activity-desc">{{ activity.description }}</span>
            <span class="activity-date">{{ activity.date | date:'short' }}</span>
            <span class="activity-amount" *ngIf="activity.amount">
              {{ activity.amount | currency:'USD':'symbol':'1.2-2' }}
            </span>
            <span class="activity-amount" *ngIf="!activity.amount">‚Äî</span>
          </div>
        </div>
        <div class="empty-message" *ngIf="recentActivity().length === 0">
          No recent activity
        </div>
      </div>
    </div>

    <!-- Error Message -->
    <div class="error-banner" *ngIf="errorMessage()">
      {{ errorMessage() }}
    </div>
  </div>

  <!-- Loading State -->
  <ng-template #loading>
    <div class="loading-state">
      <div class="loading-spinner"></div>
      <p>Loading consignor details...</p>
    </div>
  </ng-template>

  <!-- Mark Agreement on File Modal -->
  <div class="modal-overlay" *ngIf="showMarkOnFileModal()" (click)="closeMarkOnFileModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>Mark Agreement as Received</h2>
        <button type="button" class="close-btn" (click)="closeMarkOnFileModal()">√ó</button>
      </div>
      <div class="modal-body">
        <p>Mark this consignor's agreement as received and on file.</p>
        <div class="form-group">
          <label for="onFileNotes">Notes (optional)</label>
          <textarea
            id="onFileNotes"
            [(ngModel)]="onFileNotes"
            class="form-control"
            placeholder="e.g., Signed in store on 1/8/2025"
            rows="3"></textarea>
        </div>
      </div>
      <div class="modal-actions">
        <button type="button" class="btn-secondary" (click)="closeMarkOnFileModal()">Cancel</button>
        <button type="button" class="btn-primary" (click)="markAgreementOnFile()" [disabled]="isProcessingAgreement()">
          {{ isProcessingAgreement() ? 'Marking...' : 'Mark as Received' }}
        </button>
      </div>
    </div>
  </div>

  <!-- Upload Agreement Modal -->
  <div class="modal-overlay" *ngIf="showUploadModal()" (click)="closeUploadModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>{{ agreementStatus()?.status === 'uploaded' ? 'Replace Agreement Document' : 'Upload Agreement Document' }}</h2>
        <button type="button" class="close-btn" (click)="closeUploadModal()">√ó</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label for="agreementFile">Agreement Document</label>
          <input
            type="file"
            id="agreementFile"
            (change)="onFileSelected($event)"
            accept=".pdf,.png,.jpg,.jpeg"
            class="form-control">
          <small class="form-hint">PDF, PNG, or JPG files only. Maximum 10MB.</small>
        </div>
        <div class="form-group">
          <label for="uploadNotes">Notes (optional)</label>
          <textarea
            id="uploadNotes"
            [(ngModel)]="uploadNotes"
            class="form-control"
            placeholder="e.g., Scanned from physical copy"
            rows="3"></textarea>
        </div>
        <div class="upload-progress" *ngIf="uploadProgress() > 0">
          <div class="progress-track">
            <div class="progress-fill" [style.width.%]="uploadProgress()"></div>
          </div>
          <span>{{ uploadProgress() }}%</span>
        </div>
      </div>
      <div class="modal-actions">
        <button type="button" class="btn-secondary" (click)="closeUploadModal()">Cancel</button>
        <button type="button" class="btn-primary" (click)="uploadAgreement()" [disabled]="!selectedFile() || isProcessingAgreement()">
          {{ isProcessingAgreement() ? 'Uploading...' : 'Upload' }}
        </button>
      </div>
    </div>
  </div>

  <!-- Remove Agreement Confirmation Modal -->
  <div class="modal-overlay" *ngIf="showRemoveConfirmModal()" (click)="closeRemoveConfirmModal()">
    <div class="modal-content modal-sm" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>Remove Agreement</h2>
        <button type="button" class="close-btn" (click)="closeRemoveConfirmModal()">√ó</button>
      </div>
      <div class="modal-body">
        <p>Remove this agreement? The consignor may need to resubmit their agreement.</p>
      </div>
      <div class="modal-actions">
        <button type="button" class="btn-secondary" (click)="closeRemoveConfirmModal()">Cancel</button>
        <button type="button" class="btn-danger" (click)="removeAgreement()" [disabled]="isProcessingAgreement()">
          {{ isProcessingAgreement() ? 'Removing...' : 'Remove Agreement' }}
        </button>
      </div>
    </div>
  </div>

  <!-- Success Toast -->
  <div class="toast toast-success" *ngIf="showSuccessToast()">
    {{ successMessage() }}
  </div>

</app-owner-layout>
