<app-owner-layout>
  <div class="sales-page">
    <div class="page-header">
      <div class="header-content">
        <h1>Sales & Transactions</h1>
      </div>
      <div class="header-actions">
        <button class="btn-primary" routerLink="/owner/record-sale">
          <span>üí∞</span>
          Record Sale
        </button>
      </div>
    </div>

    <!-- Transactions Table -->
    <div class="table-wrapper">
      <table class="data-table">
        <thead>
          <!-- Column Headers -->
          <tr class="header-row">
            <th (click)="setSorting('saleDate')" class="sortable">
              Date
              <span class="sort-indicator" [class.active]="sortBy === 'saleDate'">
                {{ sortDirection === 'asc' ? '‚Üë' : '‚Üì' }}
              </span>
            </th>
            <th>Item</th>
            <th>Consignor</th>
            <th (click)="setSorting('salePrice')" class="sortable">
              Sale Price
              <span class="sort-indicator" [class.active]="sortBy === 'salePrice'">
                {{ sortDirection === 'asc' ? '‚Üë' : '‚Üì' }}
              </span>
            </th>
            <th>Payment</th>
            <th>Commission</th>
            <th>Shop Amount</th>
            <th>Actions</th>
          </tr>
          <!-- Filter Row -->
          <tr class="filter-row">
            <th>
              <input
                type="date"
                [(ngModel)]="filters.startDate"
                (change)="applyFilters()"
                class="filter-input"
                placeholder="From...">
            </th>
            <th>
              <input
                type="text"
                [(ngModel)]="filters.itemSearch"
                (input)="applyFilters()"
                class="filter-input"
                placeholder="Search items...">
            </th>
            <th>
              <input
                type="text"
                [(ngModel)]="filters.consignorSearch"
                (input)="applyFilters()"
                class="filter-input"
                placeholder="Search consignors...">
            </th>
            <th>
              <!-- No filter for price -->
            </th>
            <th>
              <select
                [(ngModel)]="filters.paymentMethod"
                (change)="applyFilters()"
                class="filter-select">
                <option value="">All</option>
                <option value="Cash">Cash</option>
                <option value="Card">Card</option>
                <option value="Online">Online</option>
              </select>
            </th>
            <th>
              <!-- No filter for commission -->
            </th>
            <th>
              <!-- No filter for shop amount -->
            </th>
            <th>
              <!-- No filter for actions -->
            </th>
          </tr>
        </thead>
        <tbody *ngIf="!isComponentLoading() && pagedResult()">
          <tr *ngFor="let transaction of pagedResult()!.items">
            <td>{{ transaction.saleDate | date:'MMM d, y' }}</td>
            <td>
              <div class="cell-primary">{{ transaction.items?.[0]?.item?.title || 'N/A' }}</div>
              <div class="cell-secondary">{{ transaction.items?.[0]?.item?.description || '' }}</div>
            </td>
            <td>
              <div class="cell-primary">{{ transaction.items?.[0]?.consignor?.name || 'N/A' }}</div>
              <div class="cell-secondary">{{ transaction.items?.[0]?.consignorSplitPercentage * 100 || 0 }}%</div>
            </td>
            <td>
              <div class="cell-primary">${{ transaction.subtotal | number:'1.2-2' }}</div>
              <div class="cell-secondary" *ngIf="transaction.taxAmount">
                +${{ transaction.taxAmount | number:'1.2-2' }} tax
              </div>
            </td>
            <td>
              <span class="badge" [ngClass]="{
                'badge-success': transaction.paymentType?.toLowerCase().includes('cash'),
                'badge-info': transaction.paymentType?.toLowerCase().includes('card') || transaction.paymentType?.toLowerCase().includes('credit') || transaction.paymentType?.toLowerCase().includes('debit'),
                'badge-warn': transaction.paymentType?.toLowerCase().includes('online') || transaction.paymentType?.toLowerCase().includes('check')
              }">
                {{ transaction.paymentType | uppercase }}
              </span>
            </td>
            <td class="cell-money">${{ (transaction.items?.[0]?.consignorAmount || 0) | number:'1.2-2' }}</td>
            <td class="cell-money">${{ (transaction.items?.[0]?.storeAmount || 0) | number:'1.2-2' }}</td>
            <td class="actions-cell">
              <button class="btn-icon" (click)="viewTransaction(transaction)" title="View Details">
                üëÅÔ∏è
              </button>
              <button class="btn-icon" (click)="editTransaction(transaction)" title="Edit">
                ‚úèÔ∏è
              </button>
              <button
                class="btn-icon danger"
                *ngIf="canVoidTransaction(transaction)"
                (click)="voidTransaction(transaction)"
                title="Void Sale">
                üóëÔ∏è
              </button>
            </td>
          </tr>
        </tbody>
      </table>

      <!-- Loading State -->
      <div class="loading-state" *ngIf="isComponentLoading()">
        <div class="loading-spinner"></div>
        <p>Loading transactions...</p>
      </div>

      <!-- Empty State -->
      <div class="empty-state" *ngIf="!isComponentLoading() && (!pagedResult() || pagedResult()!.items.length === 0)">
        <p>No transactions found.</p>
      </div>

      <!-- Pagination -->
      <div class="pagination" *ngIf="pagedResult() && pagedResult()!.totalPages > 1">
        <button
          class="page-btn"
          [disabled]="currentPage === 1"
          (click)="goToPage(currentPage - 1)">
          Previous
        </button>

        <div class="page-numbers">
          <button
            *ngFor="let page of getPageNumbers()"
            class="page-btn"
            [class.active]="page === currentPage"
            (click)="goToPage(page)">
            {{ page }}
          </button>
        </div>

        <button
          class="page-btn"
          [disabled]="currentPage === pagedResult()!.totalPages"
          (click)="goToPage(currentPage + 1)">
          Next
        </button>
      </div>
    </div>

    <!-- Transaction Detail Modal -->
    <div class="modal-overlay" *ngIf="showDetailModal && selectedTransactionForDetail()" (click)="closeDetailModal($event)">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h2>Transaction Details</h2>
          <button class="close-btn" (click)="closeDetailModal()">√ó</button>
        </div>

        <div class="modal-body" *ngIf="selectedTransactionForDetail() as transaction">
          <div class="detail-columns">
            <div class="detail-section">
              <h4>Item Details</h4>
              <div class="detail-row">
                <label>Item:</label>
                <span>{{ transaction.items?.[0]?.item?.title || 'N/A' }}</span>
              </div>
              <div class="detail-row" *ngIf="transaction.items?.[0]?.item?.description">
                <label>Description:</label>
                <span>{{ transaction.items?.[0]?.item?.description }}</span>
              </div>
              <div class="detail-row">
                <label>Sale Price:</label>
                <span>${{ transaction.subtotal | number:'1.2-2' }}</span>
              </div>
              <div class="detail-row" *ngIf="transaction.taxAmount">
                <label>Sales Tax:</label>
                <span>${{ transaction.taxAmount | number:'1.2-2' }}</span>
              </div>
              <div class="detail-row">
                <label>Total:</label>
                <span>${{ transaction.total | number:'1.2-2' }}</span>
              </div>
            </div>

            <div class="detail-section">
              <h4>Commission Split</h4>
              <div class="detail-row">
                <label>Consignor ({{ (transaction.items?.[0]?.consignorSplitPercentage || 0) * 100 }}%):</label>
                <span>${{ transaction.items?.[0]?.consignorAmount | number:'1.2-2' }}</span>
              </div>
              <div class="detail-row">
                <label>Shop ({{ 100 - ((transaction.items?.[0]?.consignorSplitPercentage || 0) * 100) }}%):</label>
                <span>${{ transaction.items?.[0]?.storeAmount | number:'1.2-2' }}</span>
              </div>
            </div>

            <div class="detail-section">
              <h4>Consignor</h4>
              <div class="detail-row">
                <label>Name:</label>
                <span>{{ transaction.items?.[0]?.consignor?.name || 'N/A' }}</span>
              </div>
              <div class="detail-row" *ngIf="transaction.items?.[0]?.consignor?.email">
                <label>Email:</label>
                <span>{{ transaction.items?.[0]?.consignor?.email }}</span>
              </div>
            </div>

            <div class="detail-section">
              <h4>Transaction Info</h4>
              <div class="detail-row">
                <label>Date:</label>
                <span>{{ transaction.saleDate | date:'MMM d, yyyy h:mm a' }}</span>
              </div>
              <div class="detail-row">
                <label>Payment:</label>
                <span>{{ transaction.paymentType }}</span>
              </div>
              <div class="detail-row">
                <label>ID:</label>
                <span>{{ transaction.id.substring(0, 8).toUpperCase() }}</span>
              </div>
            </div>
          </div>

          <div class="detail-section" *ngIf="transaction.notes">
            <h4>Notes</h4>
            <div class="notes-content">{{ transaction.notes }}</div>
          </div>
        </div>

        <div class="modal-actions">
          <button type="button" class="btn-secondary" (click)="closeDetailModal()">Close</button>
          <button type="button" class="btn-secondary" (click)="editTransactionFromDetail()">Edit</button>
          <button
            type="button"
            class="btn-danger"
            *ngIf="canVoidTransaction(selectedTransactionForDetail()!)"
            (click)="voidTransactionFromDetail()">
            Void Sale
          </button>
        </div>
      </div>
    </div>

    <!-- Edit Transaction Modal -->
    <div class="modal-overlay" *ngIf="showEditModal && selectedTransactionForEdit()" (click)="closeEditModal($event)">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h2>Edit Transaction</h2>
          <button class="close-btn" (click)="closeEditModal()">√ó</button>
        </div>

        <div class="modal-body" *ngIf="selectedTransactionForEdit() as transaction">
          <form (ngSubmit)="onSubmitEditTransaction()" #editForm="ngForm">
            <div class="form-row">
              <div class="form-group">
                <label for="editSalePrice">Sale Price *</label>
                <input
                  type="number"
                  id="editSalePrice"
                  [(ngModel)]="editForm_salePrice"
                  name="editSalePrice"
                  step="0.01"
                  min="0"
                  class="form-control"
                  required>
              </div>

              <div class="form-group">
                <label for="editSalesTax">Sales Tax</label>
                <input
                  type="number"
                  id="editSalesTax"
                  [(ngModel)]="editForm_salesTax"
                  name="editSalesTax"
                  step="0.01"
                  min="0"
                  class="form-control">
              </div>
            </div>

            <div class="form-group">
              <label for="editPaymentMethod">Payment Method *</label>
              <select
                id="editPaymentMethod"
                [(ngModel)]="editForm_paymentMethod"
                name="editPaymentMethod"
                class="form-control"
                required>
                <option value="">Select payment method...</option>
                <option value="Cash">Cash</option>
                <option value="Credit Card">Credit Card</option>
                <option value="Debit Card">Debit Card</option>
                <option value="Check">Check</option>
                <option value="Other">Other</option>
              </select>
            </div>

            <div class="form-group">
              <label for="editNotes">Notes</label>
              <textarea
                id="editNotes"
                [(ngModel)]="editForm_notes"
                name="editNotes"
                rows="2"
                class="form-control"
                placeholder="Optional notes..."></textarea>
            </div>

            <div class="modal-actions">
              <button type="button" class="btn-secondary" (click)="closeEditModal()">Cancel</button>
              <button
                type="submit"
                class="btn-primary"
                [disabled]="!editForm.form.valid || isSubmitting()">
                {{ isSubmitting() ? 'Updating...' : 'Update Transaction' }}
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Confirmation Dialog -->
    <div class="modal-overlay" *ngIf="showConfirmDialog" (click)="closeConfirmDialog()">
      <div class="modal-content confirm-dialog" (click)="$event.stopPropagation()">
        <div class="confirm-header" [class.destructive]="confirmDialog.isDestructive">
          <div class="confirm-icon">
            <span *ngIf="confirmDialog.isDestructive">‚ö†Ô∏è</span>
            <span *ngIf="!confirmDialog.isDestructive">‚ùì</span>
          </div>
          <h3>{{ confirmDialog.title }}</h3>
        </div>

        <div class="confirm-body">
          <p>{{ confirmDialog.message }}</p>
        </div>

        <div class="confirm-actions">
          <button type="button" class="btn-secondary" (click)="closeConfirmDialog()">
            {{ confirmDialog.cancelText }}
          </button>
          <button
            type="button"
            [class]="confirmDialog.isDestructive ? 'btn-danger' : 'btn-primary'"
            (click)="executeConfirmAction()">
            {{ confirmDialog.confirmText }}
          </button>
        </div>
      </div>
    </div>
  </div>
</app-owner-layout>
