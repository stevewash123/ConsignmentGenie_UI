
    <app-owner-layout>
      <div class="sales-page">
        <div class="page-header">
          <div class="header-content">
            <h1>Sales & Transactions</h1>
            <p>View and manage all sales transactions</p>
          </div>
          <div class="header-actions">
            <button class="btn-primary" routerLink="/owner/record-sale">
              <span class="btn-icon">üí∞</span>
              Record Sale
            </button>
          </div>
        </div>

        <!-- Filters Section -->
        <div class="filters-section">
          <div class="filter-row">
            <div class="filter-group">
              <label for="startDate">Start Date</label>
              <input
                type="date"
                id="startDate"
                [(ngModel)]="filters.startDate"
                (change)="applyFilters()"
                class="filter-input">
            </div>
            <div class="filter-group">
              <label for="endDate">End Date</label>
              <input
                type="date"
                id="endDate"
                [(ngModel)]="filters.endDate"
                (change)="applyFilters()"
                class="filter-input">
            </div>
            <div class="filter-group">
              <label for="paymentMethod">Payment Method</label>
              <select
                id="paymentMethod"
                [(ngModel)]="filters.paymentMethod"
                (change)="applyFilters()"
                class="filter-select">
                <option value="">All Payment Methods</option>
                <option value="Cash">Cash</option>
                <option value="Card">Card</option>
                <option value="Online">Online</option>
              </select>
            </div>
            <button class="btn-secondary" (click)="clearFilters()">
              Clear Filters
            </button>
          </div>
        </div>

        <!-- Sales Summary Cards -->
        <div class="summary-cards" *ngIf="summary()">
          <div class="summary-card total">
            <h3>Total Sales</h3>
            <div class="summary-value">\${{ summary()!.totalSales | number:'1.2-2' }}</div>
            <div class="summary-detail">{{ summary()!.transactionCount }} transactions</div>
          </div>
          <div class="summary-card shop">
            <h3>Shop Revenue</h3>
            <div class="summary-value">\${{ summary()!.totalShopAmount | number:'1.2-2' }}</div>
            <div class="summary-detail">After commissions</div>
          </div>
          <div class="summary-card consignor">
            <h3>consignor Payouts</h3>
            <div class="summary-value">\${{ summary()!.totalProviderAmount | number:'1.2-2' }}</div>
            <div class="summary-detail">Commissions owed</div>
          </div>
          <div class="summary-card average">
            <h3>Average Sale</h3>
            <div class="summary-value">\${{ summary()!.averageTransactionValue | number:'1.2-2' }}</div>
            <div class="summary-detail">Per transaction</div>
          </div>
        </div>

        <!-- Transactions Table -->
        <div class="transactions-section">
          <div class="section-header">
            <h2>Recent Transactions</h2>
            <div class="table-controls">
              <select [(ngModel)]="pageSize" (change)="updatePageSize()" class="page-size-select">
                <option value="10">10 per page</option>
                <option value="20">20 per page</option>
                <option value="50">50 per page</option>
              </select>
            </div>
          </div>

          <div class="table-container" *ngIf="!isComponentLoading() && pagedResult(); else loadingTransactions">
            <table class="transactions-table">
              <thead>
                <tr>
                  <th (click)="setSorting('saleDate')" class="sortable">
                    Date
                    <span class="sort-indicator" [class.active]="sortBy === 'saleDate'">
                      {{ sortDirection === 'asc' ? '‚Üë' : '‚Üì' }}
                    </span>
                  </th>
                  <th>Item</th>
                  <th>consignor</th>
                  <th (click)="setSorting('salePrice')" class="sortable">
                    Sale Price
                    <span class="sort-indicator" [class.active]="sortBy === 'salePrice'">
                      {{ sortDirection === 'asc' ? '‚Üë' : '‚Üì' }}
                    </span>
                  </th>
                  <th>Payment</th>
                  <th>Commission</th>
                  <th>Shop Amount</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let transaction of pagedResult()!.items" class="transaction-row">
                  <td class="date-cell">
                    {{ transaction.saleDate | date:'MMM d, y' }}
                  </td>
                  <td class="item-cell">
                    <div class="item-info">
                      <div class="item-name">{{ transaction.item.name }}</div>
                      <div class="item-description">{{ transaction.item.description }}</div>
                    </div>
                  </td>
                  <td class="consignor-cell">
                    <div class="consignor-info">
                      <div class="consignor-name">{{ transaction.consignor.name }}</div>
                      <div class="commission-rate">{{ transaction.consignorsplitPercentage }}% commission</div>
                    </div>
                  </td>
                  <td class="price-cell">
                    <div class="sale-price">\${{ transaction.salePrice | number:'1.2-2' }}</div>
                    <div class="tax-amount" *ngIf="transaction.salesTaxAmount">
                      +\${{ transaction.salesTaxAmount | number:'1.2-2' }} tax
                    </div>
                  </td>
                  <td class="payment-cell">
                    <span class="payment-badge" [class]="'payment-' + transaction.paymentMethod.toLowerCase()">
                      {{ transaction.paymentMethod }}
                    </span>
                  </td>
                  <td class="commission-cell">
                    \${{ transaction.providerAmount | number:'1.2-2' }}
                  </td>
                  <td class="shop-amount-cell">
                    \${{ transaction.shopAmount | number:'1.2-2' }}
                  </td>
                  <td class="actions-cell">
                    <div class="action-buttons">
                      <button class="btn-icon" (click)="viewTransaction(transaction)" title="View Details">
                        üëÅÔ∏è
                      </button>
                      <button class="btn-icon" (click)="editTransaction(transaction)" title="Edit">
                        ‚úèÔ∏è
                      </button>
                      <button
                        class="btn-icon danger"
                        *ngIf="canVoidTransaction(transaction)"
                        (click)="voidTransaction(transaction)"
                        title="Void Sale">
                        üóëÔ∏è
                      </button>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>

            <!-- Pagination -->
            <div class="pagination" *ngIf="pagedResult()!.totalPages > 1">
              <button
                class="page-btn"
                [disabled]="currentPage === 1"
                (click)="goToPage(currentPage - 1)">
                Previous
              </button>

              <div class="page-numbers">
                <button
                  *ngFor="let page of getPageNumbers()"
                  class="page-btn"
                  [class.active]="page === currentPage"
                  (click)="goToPage(page)">
                  {{ page }}
                </button>
              </div>

              <button
                class="page-btn"
                [disabled]="currentPage === pagedResult()!.totalPages"
                (click)="goToPage(currentPage + 1)">
                Next
              </button>
            </div>
          </div>

          <ng-template #loadingTransactions>
            <div class="loading-state" *ngIf="isComponentLoading()">
              <div class="loading-spinner"></div>
              <p>Loading transactions...</p>
            </div>
            <div class="empty-state" *ngIf="!isComponentLoading() && (!pagedResult() || pagedResult()!.items.length === 0)">
              <p>No transactions found.</p>
            </div>
          </ng-template>
        </div>


        <!-- Transaction Detail Modal -->
        <div class="modal-overlay" *ngIf="showDetailModal && selectedTransactionForDetail()" (click)="closeDetailModal($event)">
          <div class="modal-content detail-modal" (click)="$event.stopPropagation()">
            <div class="modal-header">
              <h2>Transaction Details</h2>
              <button class="close-btn" (click)="closeDetailModal()">√ó</button>
            </div>

            <div class="modal-body">
              <div class="transaction-detail" *ngIf="selectedTransactionForDetail() as transaction">
                <!-- Header with key transaction info -->
                <div class="detail-header">
                  <div class="header-main">
                    <h3>{{ transaction.item.name }}</h3>
                    <div class="header-meta">
                      <span class="transaction-id">ID: {{ transaction.id }}</span>
                      <span class="sale-date">{{ transaction.saleDate | date:'MMM d, yyyy h:mm a' }}</span>
                    </div>
                  </div>
                  <div class="header-amount">
                    <div class="sale-total">\${{ transaction.salePrice | number:'1.2-2' }}</div>
                    <div class="payment-method">
                      <span class="payment-badge" [class]="'payment-' + transaction.paymentMethod.toLowerCase()">
                        {{ transaction.paymentMethod }}
                      </span>
                    </div>
                  </div>
                </div>

                <!-- Two column layout for details -->
                <div class="detail-columns">
                  <!-- Left Column -->
                  <div class="detail-column">
                    <!-- Item Information -->
                    <div class="detail-section">
                      <h4>Item Details</h4>
                      <div class="detail-grid compact">
                        <div class="detail-row" *ngIf="transaction.item.description">
                          <label>Description:</label>
                          <span>{{ transaction.item.description }}</span>
                        </div>
                        <div class="detail-row">
                          <label>Original Price:</label>
                          <span class="amount">\${{ transaction.item.originalPrice | number:'1.2-2' }}</span>
                        </div>
                        <div class="detail-row" *ngIf="transaction.salesTaxAmount">
                          <label>Sales Tax:</label>
                          <span class="amount">\${{ transaction.salesTaxAmount | number:'1.2-2' }}</span>
                        </div>
                      </div>
                    </div>

                    <!-- Commission Split -->
                    <div class="detail-section">
                      <h4>Commission Split</h4>
                      <div class="commission-breakdown compact">
                        <div class="breakdown-row">
                          <span>consignor ({{ transaction.consignorsplitPercentage }}%)</span>
                          <span class="amount consignor-amount">\${{ transaction.providerAmount | number:'1.2-2' }}</span>
                        </div>
                        <div class="breakdown-row">
                          <span>Shop ({{ 100 - transaction.consignorsplitPercentage }}%)</span>
                          <span class="amount shop-amount">\${{ transaction.shopAmount | number:'1.2-2' }}</span>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Right Column -->
                  <div class="detail-column">
                    <!-- consignor Information -->
                    <div class="detail-section">
                      <h4>consignor</h4>
                      <div class="detail-grid compact">
                        <div class="detail-row">
                          <label>Name:</label>
                          <span>{{ transaction.consignor.name }}</span>
                        </div>
                        <div class="detail-row" *ngIf="transaction.consignor.email">
                          <label>Email:</label>
                          <span>{{ transaction.consignor.email }}</span>
                        </div>
                        <div class="detail-row">
                          <label>Commission Rate:</label>
                          <span>{{ transaction.consignorsplitPercentage }}%</span>
                        </div>
                      </div>
                    </div>

                    <!-- Audit Information -->
                    <div class="detail-section">
                      <h4>Audit Trail</h4>
                      <div class="detail-grid compact">
                        <div class="detail-row">
                          <label>Created:</label>
                          <span>{{ transaction.createdAt | date:'MMM d, yyyy h:mm a' }}</span>
                        </div>
                        <div class="detail-row">
                          <label>Updated:</label>
                          <span>{{ transaction.updatedAt | date:'MMM d, yyyy h:mm a' }}</span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Notes (full width if present) -->
                <div class="detail-section full-width" *ngIf="transaction.notes">
                  <h4>Notes</h4>
                  <div class="notes-content">
                    {{ transaction.notes }}
                  </div>
                </div>
              </div>

              <div class="modal-actions">
                <button type="button" class="btn-secondary" (click)="closeDetailModal()">Close</button>
                <button type="button" class="btn-primary" (click)="editTransactionFromDetail()">Edit Transaction</button>
                <button
                  type="button"
                  class="btn-danger"
                  *ngIf="canVoidTransaction(selectedTransactionForDetail()!)"
                  (click)="voidTransactionFromDetail()">
                  Void Sale
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Edit Transaction Modal -->
        <div class="modal-overlay" *ngIf="showEditModal && selectedTransactionForEdit()" (click)="closeEditModal($event)">
          <div class="modal-content edit-modal-content" (click)="$event.stopPropagation()">
            <div class="modal-header compact">
              <h2>Edit Transaction</h2>
              <button class="close-btn" (click)="closeEditModal()">√ó</button>
            </div>

            <div class="modal-body compact">
              <div class="edit-transaction-info" *ngIf="selectedTransactionForEdit() as transaction">
                <!-- Compact Transaction Summary -->
                <div class="transaction-summary compact">
                  <div class="summary-row">
                    <strong>{{ transaction.item.name }}</strong>
                    <span class="consignor-info">{{ transaction.consignor.name }} ({{ transaction.consignorsplitPercentage }}%)</span>
                  </div>
                </div>

                <form (ngSubmit)="onSubmitEditTransaction()" #editForm="ngForm">
                  <!-- Compact Form Layout -->
                  <div class="form-row-2">
                    <div class="form-group compact">
                      <label for="editSalePrice">Sale Price *</label>
                      <input
                        type="number"
                        id="editSalePrice"
                        [(ngModel)]="editForm_salePrice"
                        name="editSalePrice"
                        step="0.01"
                        min="0"
                        class="form-control compact"
                        required>
                    </div>

                    <div class="form-group compact">
                      <label for="editSalesTax">Sales Tax</label>
                      <input
                        type="number"
                        id="editSalesTax"
                        [(ngModel)]="editForm_salesTax"
                        name="editSalesTax"
                        step="0.01"
                        min="0"
                        class="form-control compact">
                    </div>
                  </div>

                  <div class="form-group compact">
                    <label for="editPaymentMethod">Payment Method *</label>
                    <select
                      id="editPaymentMethod"
                      [(ngModel)]="editForm_paymentMethod"
                      name="editPaymentMethod"
                      class="form-control compact"
                      required>
                      <option value="">Select payment method...</option>
                      <option value="Cash">Cash</option>
                      <option value="Credit Card">Credit Card</option>
                      <option value="Debit Card">Debit Card</option>
                      <option value="Check">Check</option>
                      <option value="Other">Other</option>
                    </select>
                  </div>

                  <!-- Inline Commission Split -->

                  <!-- Compact Notes -->
                  <div class="form-group compact">
                    <label for="editNotes">Notes</label>
                    <textarea
                      id="editNotes"
                      [(ngModel)]="editForm_notes"
                      name="editNotes"
                      rows="2"
                      class="form-control compact"
                      placeholder="Optional notes..."></textarea>
                  </div>

                  <!-- Submit Buttons -->
                  <div class="modal-actions compact">
                    <button type="button" class="btn-secondary" (click)="closeEditModal()">Cancel</button>
                    <button
                      type="submit"
                      class="btn-primary"
                      [disabled]="!editForm.form.valid || isSubmitting()"
                      [class.loading]="isSubmitting()">
                      {{ isSubmitting() ? 'Updating...' : 'Update Transaction' }}
                    </button>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>

        <!-- Styled Confirmation Dialog -->
        <div class="modal-overlay" *ngIf="showConfirmDialog" (click)="closeConfirmDialog()">
          <div class="modal-content confirm-dialog" (click)="$event.stopPropagation()">
            <div class="confirm-header" [class.destructive]="confirmDialog.isDestructive">
              <div class="confirm-icon">
                <span *ngIf="confirmDialog.isDestructive">‚ö†Ô∏è</span>
                <span *ngIf="!confirmDialog.isDestructive">‚ùì</span>
              </div>
              <h3>{{ confirmDialog.title }}</h3>
            </div>

            <div class="confirm-body">
              <p>{{ confirmDialog.message }}</p>
            </div>

            <div class="confirm-actions">
              <button type="button" class="btn-secondary" (click)="closeConfirmDialog()">
                {{ confirmDialog.cancelText }}
              </button>
              <button
                type="button"
                class="btn-primary"
                [class.btn-danger]="confirmDialog.isDestructive"
                (click)="executeConfirmAction()">
                {{ confirmDialog.confirmText }}
              </button>
            </div>
          </div>
        </div>
      </div>
    </app-owner-layout>
  