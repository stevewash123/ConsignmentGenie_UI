<div class="payouts-page">
    <!-- Page Header -->
    <div class="page-header">
      <div class="header-content">
        <h1>Payouts Management</h1>
      </div>
      <div class="header-actions">
        <button class="btn-primary secondary" (click)="refreshData()">
          üîÑ Refresh
        </button>
        <button class="btn-primary" (click)="openCreateModal()" [disabled]="pendingPayouts().length === 0">
          üí∞ Create Payout
        </button>
      </div>
    </div>

    <!-- Tab Bar -->
    <div class="tab-bar">
      <div class="tab-buttons">
        <button 
          class="tab-btn" 
          [class.active]="viewMode() === 'pending'"
          (click)="viewMode.set('pending')">
          ‚è≥ Pending Payouts
          <span class="tab-count" *ngIf="pendingPayouts().length > 0">{{ pendingPayouts().length }}</span>
        </button>
        <button 
          class="tab-btn" 
          [class.active]="viewMode() === 'history'"
          (click)="viewMode.set('history')">
          üìã Payout History
          <span class="tab-count" *ngIf="totalPayouts() > 0">{{ totalPayouts() }}</span>
        </button>
      </div>
    </div>

    <!-- Pending Payouts Tab -->
    <div class="tab-content" *ngIf="viewMode() === 'pending'">
      <!-- 
        NOTE: Card/Table view toggle intentionally hidden - deferred until after MVP.
        Currently defaulting to table view only.
        TODO: Re-enable view toggle post-MVP
      -->

      <!-- Empty State -->
      <div class="empty-state" *ngIf="pendingPayouts().length === 0">
        <div class="empty-icon">‚úÖ</div>
        <h3>No pending payouts</h3>
        <p>All consignors have been paid. New payouts will appear here when sales are made.</p>
      </div>

      <!-- Pending Payouts Table -->
      <div class="table-wrapper" *ngIf="pendingPayouts().length > 0">
        <table class="data-table">
          <thead>
            <tr class="header-row">
              <th>
                Consignor
                <app-column-filter
                  filterType="select"
                  label="Consignor"
                  [options]="pendingConsignorOptions()"
                  [value]="pendingConsignorFilter()"
                  placeholder="All"
                  (filterChange)="onPendingFilterChange('consignor', $event)"
                  (filterClear)="onPendingFilterClear('consignor')">
                </app-column-filter>
              </th>
              <th class="sortable" (click)="sortPending('amount')">
                Amount
                <span class="sort-indicator" [class.active]="pendingSortBy() === 'amount'">
                  {{ pendingSortDirection() === 'asc' ? '‚Üë' : '‚Üì' }}
                </span>
              </th>
              <th>Transactions</th>
              <th>Period</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            @for (pending of filteredPendingPayouts(); track pending.consignorId) {
              <tr>
                <td class="cell-primary">{{ pending.consignorName }}</td>
                <td class="cell-money">${{ pending.pendingAmount.toFixed(2) }}</td>
                <td>{{ pending.transactionCount }}</td>
                <td class="cell-secondary">{{ formatDate(pending.earliestSale) }} - {{ formatDate(pending.latestSale) }}</td>
                <td class="actions-cell">
                  <!-- TODO: Add chevron to expand row and show transaction details -->
                  <button class="btn-icon" (click)="generateStatementForConsignor(pending.consignorId)" title="Generate Statement">üìÑ</button>
                  <button class="btn-icon" (click)="createPayoutForConsignor(pending)" title="Pay Now">üí∞</button>
                </td>
              </tr>
            }
          </tbody>
        </table>

        <!-- No results after filtering -->
        <div class="empty-state" *ngIf="filteredPendingPayouts().length === 0">
          <div class="empty-icon">üîç</div>
          <h3>No matching payouts</h3>
          <p>No pending payouts match your current filter. Try adjusting or clearing the filter.</p>
        </div>
      </div>
    </div>

    <!-- Payout History Tab -->
    <div class="tab-content" *ngIf="viewMode() === 'history'">
      <!-- Controls Bar -->
      <div class="controls-bar">
        <div class="controls-info">
          {{ totalPayouts() }} total payouts
        </div>
        <div class="controls-group">
          <select [(ngModel)]="pageSize" (change)="onPageSizeChange()" class="filter-select page-size-select">
            <option value="10">10 per page</option>
            <option value="25">25 per page</option>
            <option value="50">50 per page</option>
            <option value="100">100 per page</option>
          </select>
        </div>
      </div>

      <!-- Loading State -->
      <div class="loading-state" *ngIf="isComponentLoading()">
        <div class="loading-spinner"></div>
        <p>Loading payouts...</p>
      </div>

      <!-- Empty State -->
      <div class="empty-state" *ngIf="!isComponentLoading() && payouts().length === 0">
        <div class="empty-icon">üìã</div>
        <h3>No payouts found</h3>
        <p>Completed payouts will appear here. Create a payout from the Pending Payouts tab.</p>
      </div>

      <!-- Payouts Table -->
      <div class="table-wrapper" *ngIf="!isComponentLoading() && payouts().length > 0">
        <table class="data-table">
          <thead>
            <tr class="header-row">
              <th class="sortable" (click)="sort('payoutNumber')">
                Payout #
                <span class="sort-indicator" [class.active]="sortBy() === 'payoutNumber'">
                  {{ sortDirection() === 'asc' ? '‚Üë' : '‚Üì' }}
                </span>
              </th>
              <th>
                Consignor
                <app-column-filter
                  filterType="select"
                  label="Consignor"
                  [options]="consignorOptions()"
                  [value]="selectedConsignorId()"
                  placeholder="All"
                  (filterChange)="onFilterChange('consignor', $event)"
                  (filterClear)="onFilterClear('consignor')">
                </app-column-filter>
              </th>
              <th class="sortable" (click)="sort('payoutDate')">
                Payout Date
                <span class="sort-indicator" [class.active]="sortBy() === 'payoutDate'">
                  {{ sortDirection() === 'asc' ? '‚Üë' : '‚Üì' }}
                </span>
                <app-column-filter
                  filterType="dateRange"
                  label="Date Range"
                  [value]="dateRangeFilter()"
                  (filterChange)="onFilterChange('dateRange', $event)"
                  (filterClear)="onFilterClear('dateRange')">
                </app-column-filter>
              </th>
              <th class="sortable" (click)="sort('amount')">
                Amount
                <span class="sort-indicator" [class.active]="sortBy() === 'amount'">
                  {{ sortDirection() === 'asc' ? '‚Üë' : '‚Üì' }}
                </span>
              </th>
              <th>
                Payment Method
                <app-column-filter
                  filterType="select"
                  label="Payment Method"
                  [options]="paymentMethodOptions"
                  [value]="selectedPaymentMethod()"
                  placeholder="All"
                  (filterChange)="onFilterChange('paymentMethod', $event)"
                  (filterClear)="onFilterClear('paymentMethod')">
                </app-column-filter>
              </th>
              <th>Period</th>
              <th>Transactions</th>
              <th>
                Status
                <app-column-filter
                  filterType="select"
                  label="Status"
                  [options]="statusOptions"
                  [value]="selectedStatus()"
                  placeholder="All"
                  (filterChange)="onFilterChange('status', $event)"
                  (filterClear)="onFilterClear('status')">
                </app-column-filter>
              </th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            @for (payout of payouts(); track payout.id) {
              <tr>
                <td class="cell-mono">{{ payout.payoutNumber }}</td>
                <td class="cell-primary">{{ payout.consignor.name }}</td>
                <td>{{ formatDate(payout.payoutDate) }}</td>
                <td class="cell-money">${{ payout.amount.toFixed(2) }}</td>
                <td>{{ payout.paymentMethod }}</td>
                <td class="cell-secondary">{{ formatDate(payout.periodStart) }} - {{ formatDate(payout.periodEnd) }}</td>
                <td class="text-center">{{ payout.transactionCount }}</td>
                <td>
                  <span class="badge" [ngClass]="getStatusBadgeClass(payout.status)">
                    {{ payout.status }}
                  </span>
                </td>
                <td class="actions-cell">
                  <button class="btn-icon" (click)="viewPayout(payout.id)" title="View Details">üëÅÔ∏è</button>
                  <button class="btn-icon" (click)="editPayout(payout)" title="Edit">‚úèÔ∏è</button>
                  <button class="btn-icon" (click)="exportPayout(payout.id, 'csv')" title="Export CSV">üì•</button>
                </td>
              </tr>
            }
          </tbody>
        </table>
      </div>

      <!-- Pagination -->
      <div class="pagination" *ngIf="totalPages() > 1">
        <button class="page-btn" [disabled]="currentPage() === 1" (click)="goToPage(currentPage() - 1)">Previous</button>
        <div class="page-numbers">
          @for (page of visiblePages(); track page) {
            <button class="page-btn" [class.active]="page === currentPage()" (click)="goToPage(page)">{{ page }}</button>
          }
        </div>
        <button class="page-btn" [disabled]="currentPage() === totalPages()" (click)="goToPage(currentPage() + 1)">Next</button>
      </div>
    </div>

    <!-- Create Payout Modal -->
    <div class="modal-overlay" *ngIf="showCreatePayoutModal()" (click)="closeModal($event)">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h2>üí∞ Create New Payout</h2>
          <button class="close-btn" (click)="closeCreateModal()">√ó</button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label for="consignorId">Consignor <span class="required">*</span></label>
            <select 
              id="consignorId"
              [ngModel]="newPayout().consignorId" 
              (ngModelChange)="updateConsignorId($event)"
              class="form-control">
              <option value="">Select Consignor</option>
              <option *ngFor="let pending of pendingPayouts()" [value]="pending.consignorId">
                {{ pending.consignorName }} - ${{ pending.pendingAmount.toFixed(2) }}
              </option>
            </select>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="payoutDate">Payout Date <span class="required">*</span></label>
              <input 
                type="date" 
                id="payoutDate"
                [ngModel]="newPayout().payoutDate" 
                (ngModelChange)="updatePayoutDate($event)"
                class="form-control">
            </div>

            <div class="form-group">
              <label for="paymentMethod">Payment Method <span class="required">*</span></label>
              <select 
                id="paymentMethod"
                [ngModel]="newPayout().paymentMethod" 
                (ngModelChange)="updatePaymentMethod($event)"
                class="form-control">
                <option value="">Select Method</option>
                <option value="Venmo">Venmo</option>
                <option value="Zelle">Zelle</option>
                <option value="PayPal">PayPal</option>
                <option value="Check">Check</option>
                <option value="Cash">Cash</option>
                <option value="Bank Transfer">Bank Transfer</option>
                <option value="Other">Other</option>
              </select>
            </div>
          </div>

          <div class="form-group" *ngIf="newPayout().paymentMethod === 'Check'">
            <label for="paymentReference">Check Number</label>
            <input 
              type="text" 
              id="paymentReference"
              [ngModel]="newPayout().paymentReference" 
              (ngModelChange)="updatePaymentReference($event)"
              class="form-control" 
              placeholder="Enter check number">
          </div>

          <div class="form-group">
            <label for="notes">Notes</label>
            <textarea 
              id="notes"
              [ngModel]="newPayout().notes" 
              (ngModelChange)="updateNotes($event)"
              class="form-control" 
              rows="3" 
              placeholder="Optional notes..."></textarea>
          </div>
        </div>
        <div class="modal-actions">
          <button class="btn-secondary" (click)="closeCreateModal()">Cancel</button>
          <button class="btn-primary" (click)="createPayout()">Create Payout</button>
        </div>
      </div>
    </div>

    <!-- View Payout Modal -->
    <div class="modal-overlay" *ngIf="showViewModal() && selectedPayout()" (click)="closeModal($event)">
      <div class="modal-content modal-lg" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h2>üìã Payout Details - {{ selectedPayout()?.payoutNumber }}</h2>
          <button class="close-btn" (click)="closeViewModal()">√ó</button>
        </div>
        <div class="modal-body">
          <div class="details-grid">
            <div class="detail-item">
              <label>Consignor</label>
              <span>{{ selectedPayout()?.consignor.name }}</span>
            </div>
            <div class="detail-item">
              <label>Amount</label>
              <span class="cell-money">${{ selectedPayout()?.amount.toFixed(2) }}</span>
            </div>
            <div class="detail-item">
              <label>Payout Date</label>
              <span>{{ formatDate(selectedPayout()?.payoutDate!) }}</span>
            </div>
            <div class="detail-item">
              <label>Payment Method</label>
              <span>{{ selectedPayout()?.paymentMethod }}</span>
            </div>
            <div class="detail-item">
              <label>Period</label>
              <span>{{ formatDate(selectedPayout()?.periodStart!) }} - {{ formatDate(selectedPayout()?.periodEnd!) }}</span>
            </div>
            <div class="detail-item">
              <label>Status</label>
              <span class="badge" [ngClass]="getStatusBadgeClass(selectedPayout()?.status || '')">
                {{ selectedPayout()?.status }}
              </span>
            </div>
          </div>

          <div class="detail-item" *ngIf="selectedPayout()?.paymentReference">
            <label>Payment Reference</label>
            <span>{{ selectedPayout()?.paymentReference }}</span>
          </div>

          <div class="detail-item" *ngIf="selectedPayout()?.notes">
            <label>Notes</label>
            <p>{{ selectedPayout()?.notes }}</p>
          </div>

          <!-- Transactions Table -->
          <div class="transactions-section">
            <h4>Transactions ({{ selectedPayout()?.transactions.length }})</h4>
            <div class="table-wrapper">
              <table class="data-table">
                <thead>
                  <tr class="header-row">
                    <th>Item</th>
                    <th>Sale Date</th>
                    <th>Sale Price</th>
                    <th>Consignor Amount</th>
                    <th>Shop Amount</th>
                  </tr>
                </thead>
                <tbody>
                  @for (transaction of selectedPayout()?.transactions; track transaction.transactionId) {
                    <tr>
                      <td>{{ transaction.itemName }}</td>
                      <td>{{ formatDate(transaction.saleDate) }}</td>
                      <td>${{ transaction.salePrice.toFixed(2) }}</td>
                      <td class="cell-money">${{ transaction.consignorAmount.toFixed(2) }}</td>
                      <td>${{ transaction.shopAmount.toFixed(2) }}</td>
                    </tr>
                  }
                </tbody>
              </table>
            </div>
          </div>
        </div>
        <div class="modal-actions">
          <button class="btn-secondary" (click)="closeViewModal()">Close</button>
          <button class="btn-primary secondary" (click)="exportPayout(selectedPayout()!.id, 'csv')">üì• Export CSV</button>
        </div>
      </div>
    </div>

    <!-- Consignor Statement Modal -->
    <app-consignor-statement-modal
      [isVisible]="showStatementModal()"
      [availableConsignors]="availableConsignorOptions()"
      (onClose)="closeStatementModal()">
    </app-consignor-statement-modal>
</div>
