<div class="items-page">
  <div class="page-header">
    <h1>Items</h1>
    <div class="notifications" *ngIf="activeTab === 'active' && getPriceChangeRequestsCount() > 0">
      <div class="price-request-alert">
        âš ï¸ {{ getPriceChangeRequestsCount() }} item(s) need your response for price changes
      </div>
    </div>
  </div>

  <!-- Tab Navigation -->
  <div class="tab-bar">
    <div class="tab-buttons">
      <button
        class="tab-btn"
        [class.active]="activeTab === 'active'"
        (click)="switchTab('active')">
        ğŸ“¦ Active Items
        <span class="tab-count" *ngIf="itemsResponse?.totalCount">({{ itemsResponse.totalCount }})</span>
      </button>
      <button
        class="tab-btn"
        [class.active]="activeTab === 'manifests'"
        (click)="switchTab('manifests')">
        ğŸ“‹ New Items
        <span class="tab-count" *ngIf="dropoffRequests.length">({{ dropoffRequests.length }})</span>
      </button>
    </div>
    <div class="tab-bar-actions" *ngIf="activeTab === 'manifests'">
      <a routerLink="/consignor/dropoff-requests/create" class="btn-primary secondary">
        ğŸ“¦ Create New Manifest
      </a>
    </div>
  </div>

  <!-- Active Items Tab Content -->
  <div *ngIf="activeTab === 'active'" class="tab-content">
    <!-- Status Filter Tabs -->
  <div class="filter-tabs">
    <button
      class="filter-tab"
      [class.active]="selectedStatus === null"
      (click)="onFilterByStatus(null)">
      All ({{ getStatusCount('all') }})
    </button>
    <button
      class="filter-tab"
      [class.active]="selectedStatus === 'available'"
      (click)="onFilterByStatus('available')">
      Available ({{ getStatusCount('available') }})
    </button>
    <button
      class="filter-tab"
      [class.active]="selectedStatus === 'sold'"
      (click)="onFilterByStatus('sold')">
      Sold ({{ getStatusCount('sold') }})
    </button>
    <button
      class="filter-tab"
      [class.active]="selectedStatus === 'returned'"
      (click)="onFilterByStatus('returned')">
      Returned ({{ getStatusCount('returned') }})
    </button>
    <button
      class="filter-tab"
      [class.active]="selectedStatus === 'expired'"
      (click)="onFilterByStatus('expired')">
      Expired ({{ getStatusCount('expired') }})
    </button>
  </div>

    <!-- Controls Bar -->
    <div class="controls-bar">
      <div class="search-group">
        <input
          type="text"
          placeholder="Search items..."
          [value]="searchText"
          (input)="onSearchInput($event)"
          class="search-input">
      </div>
      <div class="controls-group">
        <select class="page-size-select" [(ngModel)]="pageSize" (change)="loadItems()">
          <option value="12">12 per page</option>
          <option value="25">25 per page</option>
          <option value="50">50 per page</option>
        </select>
      </div>
    </div>

  <!-- Success Message -->
  <div class="success-message" *ngIf="showSuccessMessage">
    <span class="success-text">âœ“ {{ successMessage }}</span>
    <button class="dismiss-success" (click)="dismissSuccessMessage()">Ã—</button>
  </div>

  <!-- Active Filters Display -->
  <div class="active-filters" *ngIf="getActiveFiltersText()">
    <span class="filters-text">{{ getActiveFiltersText() }}</span>
    <button class="clear-filters" (click)="clearFilters()">Clear Filters</button>
  </div>

  <!-- Loading State -->
  <div class="loading" *ngIf="loading">
    <div class="loading-spinner"></div>
    <p>Loading items...</p>
  </div>

  <!-- Error State -->
  <div class="error-state" *ngIf="error">
    <p>{{ error }}</p>
    <button class="retry-button" (click)="loadItems()">Try Again</button>
  </div>

  <!-- Items Table -->
  <div class="table-container" *ngIf="!loading && !error && hasItems()">
    <table class="data-table">
      <thead>
        <tr>
          <th>Image</th>
          <th class="sortable" (click)="onSortChange('name')">
            Item Name
            <span class="sort-indicator">{{ getSortIcon('name') }}</span>
          </th>
          <th class="sortable" (click)="onSortChange('price')">
            Listed Price
            <span class="sort-indicator">{{ getSortIcon('price') }}</span>
          </th>
          <th>Your Earnings</th>
          <th>Status</th>
          <th class="sortable" (click)="onSortChange('listedDate')">
            Date Listed
            <span class="sort-indicator">{{ getSortIcon('listedDate') }}</span>
          </th>
          <th>Expires / Retrieve By</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let item of itemsResponse!.items"
            [class.has-price-request]="hasPriceChangeRequest(item)"
            [class.expired-item]="item.status === 'expired'">
          <td class="image-cell">
            <img *ngIf="item.thumbnailUrl"
                 [src]="item.thumbnailUrl"
                 [alt]="item.name"
                 class="item-thumbnail">
            <div *ngIf="!item.thumbnailUrl" class="no-image">ğŸ“·</div>
          </td>
          <td>
            <div class="cell-primary">{{ item.name }}</div>
            <div class="cell-secondary" *ngIf="item.sku">SKU: {{ item.sku }}</div>
          </td>
          <td class="cell-money">${{ item.listedPrice | number:'1.2-2' }}</td>
          <td class="cell-money">${{ item.consignorEarnings | number:'1.2-2' }}</td>
          <td>
            <span class="badge" [ngClass]="{
              'badge-success': item.status === 'available',
              'badge-info': item.status === 'sold',
              'badge-neutral': item.status === 'returned',
              'badge-warn': item.status === 'expired'
            }">{{ item.status | titlecase }}</span>
          </td>
          <td>{{ item.listedDate | date:'MMM d, y' }}</td>
          <td>
            <div *ngIf="item.status !== 'expired'; else expiredTemplate">
              <span [title]="'Item expires on ' + (item.expirationDate | date:'MMM d, yyyy')">
                {{ item.expirationDate | date:'MMM d, y' }}
              </span>
            </div>
            <ng-template #expiredTemplate>
              <div class="expired-dates">
                <div class="expired-label" [title]="'Item expired on ' + (item.expirationDate | date:'MMM d, yyyy')">
                  Expired: {{ item.expirationDate | date:'MMM d, y' }}
                </div>
                <div class="retrieval-label" *ngIf="item.retrievalDate"
                     [title]="'Please retrieve by ' + (item.retrievalDate | date:'MMM d, yyyy')">
                  Retrieve by: {{ item.retrievalDate | date:'MMM d, y' }}
                </div>
              </div>
            </ng-template>
          </td>
          <td>
            <button class="btn-icon" (click)="onItemClick(item)" title="View Details">ğŸ‘ï¸</button>
            <button *ngIf="hasPriceChangeRequest(item)"
                    class="btn-icon warn"
                    (click)="onRespondToPriceChange(item)"
                    title="Respond to Price Change">âš ï¸</button>
            <button *ngIf="canEditItems() && (item.status === 'available' || item.status === 'expired')"
                    class="btn-icon edit"
                    (click)="onEditItem(item)"
                    title="Edit Item Details">âœï¸</button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Empty State -->
  <div class="empty-state" *ngIf="!loading && !error && !hasItems() && itemsResponse">
    <div class="empty-icon">ğŸ“¦</div>
    <h3 class="empty-title">No items found</h3>
    <p class="empty-message">
      <span *ngIf="!getActiveFiltersText()">
        You haven't consigned any items yet.
      </span>
      <span *ngIf="getActiveFiltersText()">
        No items match your current filters.
      </span>
    </p>
    <button
      class="clear-filters"
      *ngIf="getActiveFiltersText()"
      (click)="clearFilters()">
      Clear Filters
    </button>
  </div>

  <!-- Pagination -->
  <div class="pagination" *ngIf="itemsResponse && itemsResponse.totalPages > 1">
    <button
      class="pagination-btn"
      [disabled]="currentPage === 1"
      (click)="onPageChange(currentPage - 1)">
      â† Previous
    </button>

    <span class="pagination-info">
      Page {{ currentPage }} of {{ itemsResponse.totalPages }}
      ({{ itemsResponse.totalCount }} items)
    </span>

    <button
      class="pagination-btn"
      [disabled]="currentPage === itemsResponse.totalPages"
      (click)="onPageChange(currentPage + 1)">
      Next â†’
    </button>
  </div>

  <!-- Load More for Mobile -->
  <div class="load-more" *ngIf="itemsResponse && itemsResponse.totalPages > 1">
    <button
      class="load-more-btn"
      [disabled]="currentPage === itemsResponse.totalPages"
      (click)="onLoadMore()">
      Load More
    </button>
  </div>
  </div>

  <!-- Manifests Tab Content -->
  <div *ngIf="activeTab === 'manifests'" class="tab-content">
    <!-- Filters -->
    <div class="filter-section">
      <div class="filter-container">
        <label for="statusFilter" class="filter-label">
          Filter by Status
        </label>
        <select id="statusFilter"
                class="status-select"
                [(ngModel)]="dropoffQuery.status"
                (ngModelChange)="onManifestStatusChange()">
          <option *ngFor="let option of statusOptions" [value]="option.value">
            {{ option.label }}
          </option>
        </select>
      </div>
    </div>

    <!-- Loading State -->
    <div *ngIf="manifestsLoading" class="loading">
      <p>Loading manifests...</p>
    </div>

    <!-- Error State -->
    <div *ngIf="manifestsError && !manifestsLoading" class="error">
      <p>{{ manifestsError }}</p>
      <button (click)="loadManifests()" class="retry-btn">Try Again</button>
    </div>

    <!-- Manifests List -->
    <div *ngIf="!manifestsLoading && !manifestsError">
      <!-- Empty State -->
      <div *ngIf="dropoffRequests.length === 0" class="empty-state">
        <div class="empty-content">
          <div class="empty-icon">ğŸ“¦</div>
          <h3>No Item Manifests Yet</h3>
          <p>Submit your first manifest to get your items into the shop inventory.</p>
          <a routerLink="/consignor/dropoff-requests/create" class="create-btn">
            Create Your First Manifest
          </a>
        </div>
      </div>

      <!-- Request Cards -->
      <div class="manifests-list">
        <div *ngFor="let request of dropoffRequests" class="manifest-card">
          <div class="card-header">
            <div class="manifest-info">
              <h3 class="manifest-title">
                {{ request.itemCount }} {{ request.itemCount === 1 ? 'Item' : 'Items' }}
              </h3>
              <div [class]="getStatusBadgeClass(request.status)">
                {{ request.status | titlecase }}
              </div>
            </div>
            <div class="card-actions">
              <button class="actions-btn"
                      (click)="toggleActionMenu(request.id)"
                      type="button">
                â‹®
              </button>
              <!-- Action Menu -->
              <div *ngIf="openActionMenu === request.id" class="action-menu">
                <a [routerLink]="'/consignor/dropoff-requests/' + request.id" class="menu-item">
                  ğŸ‘ï¸ View Details
                </a>
                <button *ngIf="canCancel(request.status)"
                        (click)="cancelRequest(request)"
                        class="menu-item cancel-item">
                  ğŸ—‘ï¸ Cancel Request
                </button>
              </div>
            </div>
          </div>

          <div class="card-details">
            <div class="detail-item">
              <span class="detail-label">Suggested Total:</span>
              <span class="detail-value">{{ request.suggestedTotal | currency }}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Submitted:</span>
              <span class="detail-value">{{ formatDate(request.createdAt.toString()) }}</span>
            </div>
            <div *ngIf="request.plannedDate" class="detail-item">
              <span class="detail-label">Planned Drop-off:</span>
              <span class="detail-value">
                {{ formatDate(request.plannedDate) }}
                <span *ngIf="request.plannedTimeSlot" class="time-slot">({{ request.plannedTimeSlot }})</span>
              </span>
            </div>
            <div *ngIf="request.importedAt" class="detail-item success">
              <span class="detail-label">Status:</span>
              <span class="detail-value">âœ… Imported to inventory on {{ formatDate(request.importedAt.toString()) }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Click outside to close menu -->
    <div *ngIf="openActionMenu"
         class="menu-overlay"
         (click)="toggleActionMenu('')"></div>
  </div>

  <!-- Price Change Response Modal -->
  <app-respond-price-change
    *ngIf="selectedItemForPriceResponse"
    [item]="selectedItemForPriceResponse"
    [isOpen]="showPriceChangeModal"
    (close)="onClosePriceChangeModal()"
    (submitted)="onPriceChangeSubmitted($event)">
  </app-respond-price-change>

  <!-- Edit Item Modal -->
  <app-edit-item-modal
    *ngIf="selectedItemForEdit"
    [item]="selectedItemForEdit"
    [isOpen]="showEditItemModal"
    (close)="onCloseEditItemModal()"
    (submitted)="onItemEditSubmitted($event)">
  </app-edit-item-modal>
</div>