<!-- POS/Sales Page -->
<div class="pos-container">
  <!-- Header -->
  <div class="pos-header">
    <h1 class="text-2xl font-bold text-gray-800">Point of Sale</h1>
    <div class="flex items-center gap-4">
      <!-- Navigation buttons for owners -->
      <button
        *ngIf="permissionService.isOwner()"
        type="button"
        class="btn btn-outline"
        (click)="goToInventory()">
        Inventory
      </button>
      <button
        *ngIf="permissionService.isOwner()"
        type="button"
        class="btn btn-outline"
        (click)="goToDashboard()">
        Dashboard
      </button>
    </div>
  </div>

  <!-- Main Content -->
  <div class="pos-main">
    <!-- Left Panel: Search & Results -->
    <div class="search-panel">
      <div class="search-section">
        <h2 class="text-lg font-semibold mb-3">üîç Search / Scan</h2>

        <!-- Search Input -->
        <div class="search-input-group">
          <input
            type="text"
            class="form-input w-full"
            placeholder="SKU, name, or scan barcode..."
            [value]="searchQuery()"
            (input)="onSearchQueryChange($any($event.target).value)"
            #searchInput>
          <div *ngIf="isSearching()" class="absolute right-3 top-3">
            <div class="loading-spinner"></div>
          </div>
        </div>
      </div>

      <!-- Search Results -->
      <div *ngIf="searchResults().length > 0" class="search-results">
        <h3 class="text-md font-medium mb-2">Search Results:</h3>
        <div class="results-grid">
          <div
            *ngFor="let item of searchResults()"
            class="result-card"
            [class.in-cart]="cartItems().some(cartItem => cartItem.id === item.id)">

            <!-- Item Image -->
            <div class="result-image">
              <img
                *ngIf="item.primaryImageUrl; else noImage"
                [src]="item.primaryImageUrl"
                [alt]="item.name"
                class="w-full h-full object-cover">
              <ng-template #noImage>
                <div class="no-image-placeholder">üì∑</div>
              </ng-template>
            </div>

            <!-- Item Details -->
            <div class="result-details">
              <h4 class="font-medium text-sm">{{ item.name }}</h4>
              <p class="text-lg font-bold text-green-600">{{ formatCurrency(item.price) }}</p>

              <!-- Consignor info (owner only or if permission enabled) -->
              <p *ngIf="canViewConsignorInfo() && item.consignorName"
                 class="text-xs text-gray-600">
                {{ item.consignorName }}
              </p>

              <!-- Cost info (owner only) -->
              <p *ngIf="canViewCostInfo() && item.cost"
                 class="text-xs text-gray-500">
                Cost: {{ formatCurrency(item.cost) }}
              </p>
            </div>

            <!-- Add Button -->
            <button
              type="button"
              class="add-to-cart-btn"
              [disabled]="cartItems().some(cartItem => cartItem.id === item.id)"
              (click)="addToCart(item)">
              <span *ngIf="!cartItems().some(cartItem => cartItem.id === item.id)">+</span>
              <span *ngIf="cartItems().some(cartItem => cartItem.id === item.id)">‚úì</span>
            </button>
          </div>
        </div>
      </div>

      <!-- Empty state -->
      <div *ngIf="!searchResults().length && !isSearching() && searchQuery()"
           class="empty-results">
        <p class="text-gray-500 text-center py-8">
          No items found for "{{ searchQuery() }}"
        </p>
      </div>
    </div>

    <!-- Right Panel: Cart -->
    <div class="cart-panel">
      <div class="cart-header">
        <h2 class="text-lg font-semibold">Cart</h2>
        <button
          *ngIf="!cartService.isEmpty()"
          type="button"
          class="btn btn-sm btn-outline"
          (click)="clearCart()">
          Clear Cart
        </button>
      </div>

      <!-- Cart Items -->
      <div class="cart-items" *ngIf="!cartService.isEmpty()">
        <div *ngFor="let item of cartItems()" class="cart-item">
          <div class="cart-item-info">
            <h4 class="font-medium">{{ item.name }}</h4>
            <p class="text-sm text-gray-600">{{ item.sku }}</p>
            <p *ngIf="canViewConsignorInfo() && item.consignorName"
               class="text-xs text-gray-500">{{ item.consignorName }}</p>
          </div>

          <div class="cart-item-controls">
            <div class="quantity-controls">
              <button
                type="button"
                class="quantity-btn"
                (click)="updateQuantity(item.id, item.quantity - 1)">
                ‚àí
              </button>
              <span class="quantity">{{ item.quantity }}</span>
              <button
                type="button"
                class="quantity-btn"
                (click)="updateQuantity(item.id, item.quantity + 1)">
                +
              </button>
            </div>

            <p class="item-price">{{ formatCurrency(item.price * item.quantity) }}</p>

            <button
              type="button"
              class="remove-btn"
              (click)="removeFromCart(item.id)"
              title="Remove from cart">
              √ó
            </button>
          </div>
        </div>
      </div>

      <!-- Empty Cart -->
      <div *ngIf="cartService.isEmpty()" class="empty-cart">
        <p class="text-gray-500 text-center py-8">Cart is empty</p>
      </div>

      <!-- Cart Totals -->
      <div *ngIf="!cartService.isEmpty()" class="cart-totals">
        <div class="total-line">
          <span>Subtotal:</span>
          <span>{{ formatCurrency(subtotal()) }}</span>
        </div>
        <div class="total-line">
          <span>Tax (8%):</span>
          <span>{{ formatCurrency(tax()) }}</span>
        </div>
        <div class="total-line total-final">
          <span>TOTAL:</span>
          <span>{{ formatCurrency(total()) }}</span>
        </div>
      </div>

      <!-- Payment Section -->
      <div *ngIf="!cartService.isEmpty()" class="payment-section">
        <div class="payment-methods">
          <label class="text-sm font-medium">Payment:</label>
          <div class="payment-buttons">
            <button
              *ngFor="let type of paymentTypes"
              type="button"
              class="payment-btn"
              [class.active]="paymentType() === type"
              (click)="onPaymentTypeChanged(type)">
              {{ type }}
            </button>
          </div>
        </div>

        <!-- Customer Email -->
        <div class="customer-email">
          <label for="customerEmail" class="text-sm font-medium">
            Customer Email (optional)
          </label>
          <input
            id="customerEmail"
            type="email"
            class="form-input"
            placeholder="customer@example.com"
            [value]="customerEmail()"
            (input)="onCustomerEmailChanged($any($event.target).value)">
        </div>

        <!-- Action Buttons -->
        <div class="action-buttons">
          <!-- Owner-only action buttons -->
          <div *ngIf="permissionService.isOwner()" class="owner-actions">
            <button type="button" class="btn btn-sm btn-outline" (click)="applyDiscount()">
              Discount
            </button>
            <button type="button" class="btn btn-sm btn-outline" (click)="voidTransaction()">
              Void
            </button>
          </div>

          <!-- Clerk action buttons (with PIN) -->
          <div *ngIf="permissionService.isClerk()" class="clerk-actions">
            <button type="button" class="btn btn-sm btn-outline" (click)="applyDiscount()">
              Discount (PIN)
            </button>
            <button type="button" class="btn btn-sm btn-outline" (click)="voidTransaction()">
              Void (PIN)
            </button>
          </div>

          <!-- Complete Sale Button -->
          <button
            type="button"
            class="btn btn-primary btn-lg complete-sale-btn"
            [disabled]="isCompletingSale()"
            (click)="completeSale()">
            <span *ngIf="!isCompletingSale()">COMPLETE SALE</span>
            <span *ngIf="isCompletingSale()">Processing...</span>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Error Message -->
<div *ngIf="errorMessage()" class="error-banner">
  <div class="error-content">
    <span>{{ errorMessage() }}</span>
    <button type="button" class="error-close" (click)="clearError()">√ó</button>
  </div>
</div>

<!-- PIN Modal -->
<div *ngIf="showPinModal()" class="modal-overlay">
  <div class="modal-content">
    <div class="modal-header">
      <h3 class="text-lg font-semibold">Owner PIN Required</h3>
    </div>
    <div class="modal-body">
      <p class="text-sm text-gray-600 mb-4">
        Enter owner PIN to {{ pinModalAction() }}:
      </p>
      <input
        type="password"
        class="form-input"
        placeholder="Enter PIN"
        [value]="pinInput()"
        (input)="pinInput.set($any($event.target).value)"
        (keyup.enter)="verifyPin()">
      <div *ngIf="pinError()" class="text-red-600 text-sm mt-2">
        {{ pinError() }}
      </div>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn btn-outline" (click)="cancelPinModal()">
        Cancel
      </button>
      <button type="button" class="btn btn-primary" (click)="verifyPin()">
        Verify
      </button>
    </div>
  </div>
</div>

<!-- Sale Completion Modal -->
<div *ngIf="saleCompleted()" class="modal-overlay">
  <div class="modal-content">
    <div class="modal-header">
      <h3 class="text-lg font-semibold">Sale Complete!</h3>
    </div>
    <div class="modal-body">
      <div class="sale-success">
        <div class="success-icon">‚úÖ</div>
        <p class="text-lg font-semibold">Sale completed successfully!</p>
        <div *ngIf="saleResult()" class="sale-details">
          <p><strong>Total:</strong> {{ formatCurrency(saleResult().totalAmount) }}</p>
          <p><strong>Payment:</strong> {{ saleResult().paymentType }}</p>
          <p *ngIf="saleResult().receiptSent"><strong>Receipt sent!</strong></p>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn btn-outline" (click)="recordAnotherSale()">
        New Sale
      </button>
      <button type="button" class="btn btn-primary" (click)="closeSaleModal()">
        Close
      </button>
    </div>
  </div>
</div>